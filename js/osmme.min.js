function whTableSpan(f){var a=[],g;for(g in f)a.push(f[g][1]);for(g=0;g<a.length;g++){var e;a:{e=0;for(var b=g+1;b<a.length;b++){if(a[b].text!=a[g].text)break a;e++}}if(e){a[g].rspan=e;for(b=1;b<=e;b++)f[g+b][1]=null;g+=e}}}
function tagValueHTML(f){if(!0===f.value)return i18nService.tr($scope,"details.poi.tag.values.true");if(!1===f.value)return i18nService.tr($scope,"details.poi.tag.values.false");if("contact:website"==f.key)return'<a href="'+f.value+'">'+f.value+"</a>";if("opening_hours"==f.key){if(f.value["24_7"])return i18nService.tr($scope,"details.poi.tag.values.wh.24_7");f=getWHTable($scope,f,i18nService);whTableSpan(f);return 6==f[0][1].rspan?i18nService.tr($scope,"details.poi.tag.values.wh.evryday")+f[0][1].text:
whTableHTML(f)}return f.value}function whTableHTML(f){var a="<table>",g;for(g in f){var a=a+"<tr>",e;for(e in f[g]){var b=f[g][e];b&&(a+="<td",b.cspan&&(a+=' colspan="'+b.cspan+'"'),b.rspan&&(a+=' rowspan="'+b.rspan+'"'),a+=">",a+=b.text+"</td>")}a+="</tr>"}return a+"</table>"}
function getWHTable(f,a,g){var e=[],b="MO TU WE TH FR SA SU".split(" "),d;for(d in b){var h=[];e.push(h);var l=a.value[b[d]];h.push({text:f.dayNames[d]});l?l[2]?h.push({text:l[0]+"-"+l[l.length-1]+"<br>"+l[1]+"-"+l[2]}):h.push({text:l[0]+"-"+l[1]}):h.push({text:g.tr(f,"details.poi.tag.values.wh.off")})}return e}
function getAddress(f,a){if(!f)return[""];var g=!0;f.addresses&&f.addrTexts&&(g=f.addresses.length==f.addrTexts.length);if(f.addrTexts&&g)return f.addrTexts;f.address?(g=getAddrArray(f),"city-street-hn"==a&&g.reverse(),f.addrTexts=[g.join(", ")]):f.addresses&&(f.addrTexts=[],angular.forEach(f.addresses,function(e){e=getAddrArray(e);"city-street-hn"==a&&e.reverse();f.addrTexts.push(e.join(", "))}));return f.addrTexts}
function getAddrArray(f){var a=[];f.housenumber&&f.housenumber[0]&&a.push(f.housenumber[0]);f.street_name&&a.push(f.street_name);f.neighborhood_name?a.push(f.neighborhood_name):f.nearest_neighbour&&a.push(f.nearest_neighbour.name);f.locality_name?a.push(f.locality_name):f.nearest_place&&a.push(f.nearest_place.name);f.local_admin_name&&ADDR_LOCAL_ADMIN&&a.push(f.local_admin_name);f.admin2_name&&ADDR_ADMIN2&&a.push(f.admin2_name);f.admin1_name&&ADDR_ADMIN1&&a.push(f.admin1_name);f.admin0_name&&ADDR_ADMIN0&&
a.push(f.admin0_name);return a=merdgeAddrLevels(a)}function merdgeAddrLevels(f){for(var a=[f[0]],g=1;g<f.length;g++)0>f[g-1].indexOf(f[g])&&0>f[g].indexOf(f[g-1])&&a.push(f[g]);return a}
function isMobile(){var f=navigator.userAgent||navigator.vendor||window.opera;return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(f)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(f.substr(0,
4))};String.prototype.hashCode=function(){var f=0;if(0==this.length)return f;for(i=0;i<this.length;i++)c=this.charCodeAt(i),f=(f<<5)-f+c,f&=f;return f};String.prototype.format=function(){var f=arguments;return this.replace(/{(\d+)}/g,function(a,g){return"undefined"!=typeof f[g]?f[g]:a})};function filterAndSort(f){return 1<f.length?f.sort().filter(function(a,g){return!g||a!=f[g-1]}):f}var OSMmeApp=angular.module("OSMmeApp","ngCookies ngSanitize meMap meI18n angular-google-analytics meSearch meOSMDoc meIGeocoder meDetails meRouter ngDisqus".split(" "));
OSMmeApp.config(["$locationProvider",function(f){f.hashPrefix("!")}]);ANALYTICS_CODE&&OSMmeApp.config(["AnalyticsProvider",function(f){f.setAccount(ANALYTICS_CODE)}]);OSMmeApp.directive("ngEnter",function(){return function(f,a,g){a.bind("keydown keypress",function(a){13===a.which&&(f.$apply(function(){f.$eval(g.ngEnter)}),a.preventDefault())})}});
OSMmeApp.directive("meResize",["$window",function(f){return function(a,g){var e=angular.element(f);a.getWindowDimensions=function(){var a=document.body,d=document.documentElement,e=Math.max(a.scrollHeight,a.offsetHeight,d.clientHeight,d.scrollHeight,d.offsetHeight),a=Math.max(a.scrollWidth,a.offsetWidth,d.clientWidth,d.scrollWidth,d.offsetWidth);return{h:e,w:a}};a.$watch(a.getWindowDimensions,function(b,d){a.windowHeight=b.h;a.windowWidth=b.w},!0);e.bind("resize",function(){a.$apply()})}}]);
OSMmeApp.controller("MapController",["$rootScope","$scope","$cookies","i18nService","mapService","search","docTree","details","iGeocoder","$location","routeService","Analytics",function(f,a,g,e,b,d,h,l,q,m,k,p){function u(){var b=k.getParameters(),d=[],e=[];b.pg&&b.pg.split(",").forEach(function(a){a&&d.push(a)});b.pt&&b.pt.split(",").forEach(function(a){a&&e.push(a)});d=filterAndSort(d);e=filterAndSort(e);!a.osmdocCat||angular.equals(d,a.osmdocCat.groups)&&angular.equals(e,a.osmdocCat.features)||
(a.osmdocCat.groups=d,a.osmdocCat.features=e,h.organizeCathegories(),h.updateSelections(a),a.$broadcast("SelectCathegoryTreeNode"))}a.SITE_SESSION=Math.floor(65536*(1+Math.random())).toString(16).substring(1);a.HTML_ROOT=HTML_ROOT;f.HTML_ROOT=HTML_ROOT;f.pathWithRoot=function(a){return HTML_ROOT+a};a.pathWithRoot=function(a){return HTML_ROOT+a};f=m.search();k.flag("m");k.anonymous("lang");k.parameter("id");k.parameter("map",3,!0);k.parameter("pg");k.parameter("pt");k.parameter("q");k.flag("strict");
k.flag("details");k.flag("explain");if(f.fid){var r={};r.id=f.fid;f.details&&(r.details=!0);m.search("");m.path("");k.update(r)}a.searchForm={};a.langsAvaible=["en","ru"];var n=k.getParameters();0>a.langsAvaible.indexOf(n.lang)&&(m=initLang(g),0<=a.langsAvaible.indexOf(n.lang)?k.update("lang",m):k.update("lang",DEFAULT_LANGUAGE));a.mobile=isMobile();n.m!=a.mobile&&k.update("m",a.mobile);ANALYTICS_CODE&&p.trackPage("/#!/"+a.lng+"/");angular.element(document.getElementsByTagName("head")[0]).append('<link rel="stylesheet" type="text/css" href="css/'+
(a.mobile?"mobile":"descktop")+'.css" />');a.lng=n.lang||initLang(g);a.hierarchyCode=h.getHierarchyCode(a.lng);a.name2FClass={};a.name2Group={};h.loadTree(a,a.lng,a.hierarchyCode);e.getTranslation(a,a.lng,!0,function(){var f=[null,null,null];n.map&&(f=n.map);var k=b.createMap(a,f[1],f[2],f[0]);q.create(a,k);h.attach(a);d.attach(a);a.dayNames=e.tr(a,"details.poi.tag.values.wh.days").split(" ");b.enquirePosition(function(b){if(b){var d=b.coords.latitude,e=b.coords.longitude;500<k.getCenter().distanceTo([d,
e])&&q.sendRequest(e,d,!1,function(b){b&&b.text?(b.lat=d,b.lon=e,a.browserGeoLocation=b):a.browserGeoLocation&&delete a.browserGeoLocation})}})});a.activeFeatureID=n.fid;a.explain=n.explain;a.content=n.details?"details":"map";a.activeFeatureID&&("details"==a.content?l.showDetails(a,a.activeFeatureID):l.showPopup(a,a.activeFeatureID));a.switchPoiClassArray=function(b){try{var d=a.osmdocCat.features.slice(0),e=a.osmdocCat.features.indexOf(b);0>e?d.push(b):d.splice(e,1);return filterAndSort(d)}catch(h){return[]}};
a.poiClassTranslatedTitle=function(b){return b.title_by_lang&&b.title_by_lang[a.lng]?b.title_by_lang[a.lng]:b.translated_title[0]};a.$on("$locationChangeSuccess",function(){var d=a.activeFeatureID,e=k.getParameters();a.lng!=e.lang&&(g.lang=e.lang,k.reload());a.activeFeatureID=e.id;a.explain=e.explain;a.content=e.details?"details":"map";"details"==a.content?(ANALYTICS_CODE&&p.trackPage("/#!/"+a.lng+"/id/"+a.activeFeatureID+"/details"),l.showDetails(a,a.activeFeatureID),d&&l.closePopup(a,d)):(a.activeFeatureID?
(ANALYTICS_CODE&&p.trackPage("/#!/"+a.lng+"/id/"+a.activeFeatureID),l.showPopup(a,a.activeFeatureID)):void 0!==d&&d!=a.activeFeatureID&&l.closePopup(a,d),k.getParameters().map&&(d=k.getParameters().map,b.broadcastAction||b.setView(d[1],d[2],d[0])));e.strict&&(a.strictSearch=!0);e.q&&null==a.searchForm.q&&a.searchForm.q!=e.q&&(a.searchForm.q=e.q,a.$broadcast("Search",e.q));u()});a.$on("Search",function(){k.update("q",a.searchForm.q)});a.$on("SelectFeature",function(){k.update("q",a.searchForm.q)});
a.$on("HierarchyLoaded",u);a.$on("PopupClose",function(b,d){"map"==a.content&&k.update("id",null)});a.$on("PopupOpen",function(a,b){k.update({id:b,map:null})});a.$on("MapViewChanged",function(){k.update("map",b.getStateArray())});m=function(){a.osmdocCat&&(h.organizeCathegories(),0<a.osmdocCat.features.length?k.update("pt",a.osmdocCat.features.join()):k.update("pt",null),0<a.osmdocCat.groups.length?k.update("pg",a.osmdocCat.groups.join()):k.update("pg",null),b.filterMarkersByTypes(a,h.expandCathegories(a)),
h.updateSelections(a))};a.$on("CloseSearchResults",function(){a.searchForm.q="";a.searchResultsPage=null;a.srPages=null;b.filterMarkersByTypes(a,h.expandCathegories(a));h.updateSelections(a)});a.$on("SelectCathegoryTreeNode",m);a.$on("UnselectCathegoryTreeNode",m);a.formatObjectType=function(b){if(b){if(b.poi_class){var d=a.translateTypeNames(b);if(0<d.length)return d.join(", ")}if(b.weight_base_type)return e.tr(a,"weight_base_type."+b.weight_base_type)}return null};a.translateTypeNames=function(b){var d=
[];if(b&&b.poi_class)for(var e in b.poi_class){var h=b.poi_class[e];a.name2FClass&&a.name2FClass[h]&&(h=a.name2FClass[h].translated_title,h.toUpperCase()!==(b.name||"").toUpperCase()&&d.push(h))}return d};a.nameContainsType=function(b){if(b){var d=a.translateTypeNames(b);b=(b.name||"").toLowerCase();for(var e in d)if(0<=b.indexOf(d[e].toLowerCase()))return!0}return!1};a.tagValueHTML=tagValueHTML;a.buildingType=function(b){return e.tr(a,"details.adr.building")};a.mergeIntoPath=function(a,b){return"/#!"+
k.mergeIntoPath(a,b)};a.searchKeyDown=function(b){38==b.keyCode?(b.stopPropagation(),b.preventDefault(),a.$broadcast("SearchKeyUp")):40==b.keyCode&&a.$broadcast("SearchKeyDown")};a.$watch("searchForm.q",function(b,d){""!=d&&""==b&&a.$broadcast("CleanSearchInput")});a.$on("CleanSearchInput",function(){k.update("q",null)});a.navigate=function(b,a){k.update(b,a)};a.formatSearchResultTitle=function(b){if(!b)return"";if("adrpnt"==b.type)return e.tr(a,"map.js.search.title.adrpnt");if(b.name||b.poi_class){var d=
a.formatObjectType(b),h=b.name||d;b.name&&d&&(h+=" ("+d+")");return h}return""};a.formatSearchResultAddress=function(b){if(!b)return"";b=getAddress(b,a.translation?a.translation["addr.order"]:"hn-street-city");return void 0==b?"":b[0]};a.getAddress=function(b){return getAddress(b,a.translation?a.translation["addr.order"]:"hn-street-city")};a.selectRow=function(b){a.$broadcast("SelectFeature",b)};a.$on("SelectFeature",function(){a.searchForm.showSlider=!1});a.searchInputEnter=function(){a.suggestedFeature?
a.suggestedFeature.feature_id?a.$broadcast("SelectFeature",a.suggestedFeature):a.selectPoiType(a.suggestedFeature.name):a.$broadcast("Search",a.searchForm.q)};a.removeSelected=function(b,d){h.removeSelection(a,{name:b},d)};a.moveToBrowserGeoLocation=function(a){b.setView(a.lat,a.lon,14);b.saveStateToCookie()}}]);function initLang(f){return f.lang?f.lang:"en-US"===(window.navigator.language||window.navigator.userLanguage)?"en":"ru"}disqus_shortname="osmme";var router=angular.module("meRouter",[]);
router.factory("routeService",["$location",function(f){function a(){this.parameters=[];this.byName={}}a.prototype.parameter=function(a,e,b,d){e={name:a,type:"parameter",escape:d||!0,slashes:e||0,skipSave:b||!1};this.byName[a]||(this.parameters.push(e),this.byName[a]=e)};a.prototype.anonymous=function(a,e,b,d){e={name:a,type:"anonymous",escape:d||!0,skipSave:b||!1};this.byName[a]||(this.parameters.push(e),this.byName[a]=e)};a.prototype.flag=function(a,e){var b={name:a,type:"flag",skipSave:e||!1};this.byName[a]||
(this.parameters.push(b),this.byName[a]=b)};a.prototype.template=function(){var a="/";angular.forEach(this.parameters,function(e){"anonymous"==e.type&&(a+=":"+e.name+"/");"flag"==e.type&&(a+="?"+e.name+"/");if("parameter"==e.type&&(a+=e.name+"/:"+e.name+"/",e.slashes))for(var b=0;b<e.slashes-1;b++)a+=":"+e.name+"/"});return a};a.prototype.getParameters=function(){var a=[];angular.forEach(f.path().split("/"),function(b){b&&a.push(b)});for(var e=0,b={},d=0;d<a.length;d++)for(var h=e;h<this.parameters.length;h++){var l=
this.parameters[h],q=a[d];if("anonymous"==l.type){b[l.name]=q;e++;break}else if("flag"==l.type&&l.name==q){b[l.name]=!0;e++;break}else if("parameter"==l.type&&l.name==q){if(l.slashes)for(h=d+1;h<Math.min(a.length,d+1+l.slashes);h++)b[l.name]||(b[l.name]=[]),b[l.name].push(a[h]);else b[l.name]=a[d+1];d+=l.slashes||1;e++;break}e++}return b};a.prototype.createPath=function(a){for(var e="/",b=0;b<this.parameters.length;b++){var d=this.parameters[b];"anonymous"==d.type&&a[d.name]&&(e+=a[d.name]+"/");"flag"==
d.type&&a[d.name]&&(e+=d.name+"/");if("parameter"==d.type&&a[d.name])if(e+=d.name+"/",d.slashes)for(var h=0;h<d.slashes;h++)e+=a[d.name][h]+"/";else e+=a[d.name]+"/"}return e};a.prototype.update=function(a,e,b){var d={};void 0===e&&void 0===b?d=a:d[a]=e;e=angular.extend(this.getParameters(),d);e=this.createPath(e);e=f.path(e);this.byName[a]&&this.byName[a].skipSave&&!b&&e.replace();return e};a.prototype.mergeIntoPath=function(a,e){var b={};void 0===e?b=a:b[a]=e;b=angular.extend(this.getParameters(),
b);return this.createPath(b)};a.prototype.reload=function(){window.location.reload()};return new a}]);var MapModule=angular.module("meMap",["ngCookies","meI18n"]);
(function(f,a){function g(a,b){var d=Math.pow(10,b);return Math.round(a*d)/d}a.factory("mapService",["i18nService","$rootScope","$cookies","$compile","$http",function(a,b,d,h,f){var q=L.Control.extend({container:null,options:{position:"topleft"},setScope:function(a){this.scope=a;return this},setContainer:function(a){var b=L.DomUtil.create("div","search-control");L.DomEvent.disableClickPropagation(b);L.DomEvent.addListener(b,"mousewheel",function(a){var b=document.getElementById("r-scroll-pane");b&&
(b.scrollTop-=20*L.DomEvent.getWheelDelta(a));L.DomEvent.stopPropagation(a)});b.innerHTML=a;this.container=b},onAdd:function(a){return this.container}}),m={id2Feature:{},id2Marker:{},ready:!1,createMap:function(k,p,g,r){p=p||d.lat||DEFAULT_LAT;if(90<p||-90>p)p=DEFAULT_LAT;g=g||d.lon||DEFAULT_LON;if(180<g||-180>g)g=DEFAULT_LON;r=r||d.z||DEFAULT_ZOOM;0>=r&&(r=DEFAULT_ZOOM);this.map=L.map("map",{zoomControl:!1}).setView([p,g],r);p=a.tr(k,"map.js.copy.data")+' &copy; <a href="http://osm.org">'+a.tr(k,
"map.js.copy.contributors")+"</a>, "+a.tr(k,"map.js.copy.rendering")+' <a href="http://giscience.uni-hd.de/" target="_blank">University of Heidelberg</a>';k.mobile&&(p='<a href="http://osm.org">OpenStreetMap</a>,  <a href="http://giscience.uni-hd.de/" target="_blank">University of Heidelberg</a>');p=L.tileLayer(MAPSURFER_TILES,{attribution:p,maxZoom:18}).addTo(this.map);g=a.tr(k,"map.js.copy.contributors")+'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a>';r=L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",
{attribution:g});g={};g[a.tr(k,"map.js.layer.relief")]=L.tileLayer("http://openmapsurfer.uni-hd.de/tiles/asterh/x={x}&y={y}&z={z}",{maxZoom:18});g[a.tr(k,"map.js.layer.contours")]=L.tileLayer("http://openmapsurfer.uni-hd.de/tiles/asterc/x={x}&y={y}&z={z}",{maxZoom:18});p={Mapnik:r,MapSurfer:p};k.mobile||(this.layersControl=L.control.layers(p,g),this.layersControl.addTo(this.map));var n=this.map;this.map.on("viewreset",function(){window.setTimeout(function(){m.saveStateToCookie.apply(m,[]);m.broadcastAction=
!0;k.$broadcast("MapViewChanged",n.getCenter(),n.getZoom());b.$$phase||b.$apply();m.broadcastAction=!1},10)});this.map.on("moveend",function(){window.setTimeout(function(){m.saveStateToCookie.apply(m,[]);m.broadcastAction=!0;k.$broadcast("MapViewChanged",n.getCenter(),n.getZoom());b.$$phase||b.$apply();m.broadcastAction=!1},10)});this.map.on("popupopen",function(a){var d=n.project(a.popup._latlng);d.y-=a.popup._container.clientHeight/2;n.panTo(n.unproject(d),{animate:!1});k.$broadcast("PopupOpen",
a.popup._source?a.popup._source.feature_id:a.popup.feature_id);b.$$phase||b.$apply()});this.map.on("popupclose",function(a){k.$broadcast("PopupClose",a.popup._source?a.popup._source.feature_id:a.popup.feature_id);b.$$phase||b.$apply()});this.ready=!0;if(!k.mobile){var t=this.searchControl=(new q).setScope(k);f.get(HTML_ROOT+"/templates/search_control.html").success(function(a){t.setContainer(a);t.addTo(n);h(t.container)(k)})}return this.map},createPopUP:function(a,b){if(!this.id2Feature[b.feature_id]){this.id2Feature[b.feature_id]=
b;var d=b.poi_class?a.name2FClass[b.poi_class[0]]:null,e=this;this.loadIcon(d,function(){var h=L.marker([b.center_point.lat,b.center_point.lon]);d&&d.ll_icon&&(h=L.marker([b.center_point.lat,b.center_point.lon],{icon:d.ll_icon}));e.id2Marker[b.feature_id]=h;h.addTo(e.map).bindPopup(e.getPopUPHtml(b,b.feature_id,a));h.feature_id=b.feature_id})}},openPopUP:function(a,b,d){if(b&&this.id2Marker[b])if(angular.element(this.map.getContainer()).hasClass("ng-hide")){var e=this,h=d||5;0<h&&window.setTimeout(function(){e.openPopUP.apply(e,
[a,b,h])},100)}else this.id2Marker[b]._popup._isOpen||(this.map.invalidateSize(!1),this.id2Marker[b].openPopup())},closePopUP:function(a,b){b&&this.id2Marker[b]&&this.id2Marker[b].closePopup()},isPopUPExists:function(a,b){return b&&!!this.id2Marker[b]},getPopUPHtml:function(b,d,h){var f=h.formatSearchResultTitle(b);b=getAddress(b,h.translation?h.translation["addr.order"]:"hn-street-city")[0];d='<a class="more-link" href="'+h.mergeIntoPath({details:!0,id:d})+'">'+a.tr(h,"map.js.popup.more")+"</a>";
return f?'<div class="fpopup"><h2>'+f+"</h2><div>"+b+"</div><div>"+d+"</div>":"<div>"+b+"</div>"+d},remove:function(a,b){void 0!==this.id2Feature[b]&&(this.id2Marker[b]&&(this.map.removeLayer(this.id2Marker[b]),delete this.id2Marker[b]),delete this.id2Feature[b],a.activeFeatureID=null)},clearAllMarkers:function(a){this.filterMarkersByTypes(a,[])},filterMarkersByTypes:function(a,b){var d=[];angular.forEach(this.id2Feature,function(a,e){0>b.indexOf(a.class_name)&&d.push(e)});angular.forEach(d,function(b){m.remove.apply(m,
[a,b])})},getStateString:function(){var a=this.map.getCenter(),b=this.map.getZoom();return 0<b&&90>a.lat&&-90<a.lat&&-180<a.lng&&180>a.lng?b+"/"+g(a.lat,5)+"/"+g(a.lng,5):null},getStateArray:function(){var a=this.map.getCenter(),b=this.map.getZoom();return 0<b&&90>a.lat&&-90<a.lat&&-180<a.lng&&180>a.lng?[b,g(a.lat,5),g(a.lng,5)]:null},saveStateToCookie:function(){var a=this.map.getCenter(),b=this.map.getZoom();0<b&&90>a.lat&&-90<a.lat&&-180<a.lng&&180>a.lng&&(d.lat=a.lat,d.lon=a.lng,d.z=b)},setView:function(a,
b,d){0<d&&90>a&&-90<a&&-180<b&&180>b&&this.map&&this.map.setView([a,b],d)},enquirePosition:function(a){"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(a)},imgWaiters:{},loadIcon:function(a,b){if(a)if(void 0===a.ll_icon){var d=TYPE_ICONS_ROOT+"/"+a.icon;if(void 0===this.imgWaiters[d]){thisClosure=this;this.imgWaiters[d]=[];this.imgWaiters[d].push(b);var e=new Image;e.onload=function(){a.ll_icon=L.icon({iconUrl:d,iconSize:[32,37],iconAnchor:[16,37],popupAnchor:[0,-38]});for(var b=
0;b<thisClosure.imgWaiters[d].length;b++)thisClosure.imgWaiters[d][b]();thisClosure.imgWaiters[d]=null};e.onerror=function(){a.ll_icon=null;for(var b=0;b<thisClosure.imgWaiters[d].length;b++)thisClosure.imgWaiters[d][b]();thisClosure.imgWaiters[d]=null};e.src=d}else null===this.imgWaiters[d]?b():this.imgWaiters[d].push(b)}else b();else b()}};return m}])})(angular,MapModule);var meI18n=angular.module("meI18n",["ngResource"]);
meI18n.factory("i18nService",["$resource",function(f){return{getTranslation:function(a,g,e,b){var d=HTML_ROOT+"/i18n/map_"+g+".json",h="map.js_"+g;sessionStorage&&!e?sessionStorage.getItem(h)?(a.translation=JSON.parse(sessionStorage.getItem(h)),b&&b()):f(d).get(function(d){a.translation=d;sessionStorage.setItem(h,JSON.stringify(a.translation));b()}):f(d).get(function(d){a.translation=d;b()})},tr:function(a,f){return void 0!==a.translation&&void 0!==a.translation[f]?a.translation[f]:f}}}]);var meIGeocoder=angular.module("meIGeocoder",["ngResource","meMap","meDetails"]);
(function(f,a){a.factory("iGeocoder",["$http","mapService","details",function(a,e,b){return{create:function(a,b){var f=this;b.on("click",function(a){14<b.getZoom()&&f.sendRequest(a.latlng.lng,a.latlng.lat)});this.scope=a;a.closeIGeocodeResults=function(){a.$broadcast("CloseInverseGeocodeResults")};a.$on("CloseInverseGeocodeResults",function(){a.inverseGeocodeResults=null;e.filterMarkersByTypes(a,[])})},sendRequest:function(b,e,f,q){var m=this;b=API_ROOT+"/location/latlon/"+e+"/"+b;if(void 0==f||f)b+=
"/_related";void 0==q?(b+="?&max_neighbours="+(("undefined"!==typeof IGEOCODE_NEIGHBOURS?IGEOCODE_NEIGHBOURS:8)||8),a.get(b).success(function(a){m.showAnswer.apply(m,[a])})):a.get(b+"?largest_level=all&max_neighbours=0&full_geometry=false").success(q)},showAnswer:function(a){if(a){this.scope.inverseGeocodeResults=a;var b=this.scope;a.feature_id&&(this.scope.$broadcast("CloseSearchResults",a.feature_id),e.createPopUP(b,a),e.openPopUP(b,a.feature_id));a._related&&a._related._same_building&&angular.forEach(a._related._same_building,
function(a){e.createPopUP(b,a)});a._eclosed&&angular.forEach(a._eclosed,function(a){e.createPopUP(b,a)});a._neighbours&&angular.forEach(a._neighbours,function(a){e.createPopUP(b,a)})}}}}])})(angular,meIGeocoder);var meSearch=angular.module("meSearch",["meMap","meOSMDoc"]);
meSearch.factory("search",["$http","mapService","docTree",function(f,a,g){var e={resetMap:!1,selectedSuggestion:-1,queryHead:null,userSearchInput:"",restrictWithBBOX:!1,suggestTimer:null,attach:function(b){b.$on("MapViewChanged",function(a){e.pagesMode||e.listPOI.apply(e,[b,1])});b.$on("SelectCathegoryTreeNode",function(){b.searchForm.q="";delete b.searchResultsPage.features;e.pagesMode=!1;e.listPOI.apply(e,[b,1])});b.$on("UnselectCathegoryTreeNode",function(){e.pagesMode=!1;e.listPOI.apply(e,[b,
1])});b.$on("Search",function(){e.pagesCenter=a.map.getCenter();e.search.apply(e,[b,1])});b.$on("SearchKeyUp",function(){e.moveUp.apply(e,[b])});b.$on("SearchKeyDown",function(){e.moveDown.apply(e,[b])});b.$on("SelectFeature",function(d,e){a.openPopUP(b,e.feature_id)});b.$watch("searchForm.q",function(a,h){e.suppressOnSearchQuerry?e.suppressOnSearchQuerry=!1:(e.suggestTimer&&window.clearTimeout(e.suggestTimer),e.suggestTimer=window.setTimeout(function(){e.suggest(b)},300))});b.searchResultsPage={};
b.getSRPages=function(){e.listPages(b)};b.goPage=function(a){e.search(b,a.p)}},search:function(a,d){e.restrictWithBBOX=!1;e.userSearchInput="";if(a.searchForm.q){var h={q:a.searchForm.q,mark:e.getHash(a),page:d,hierarchy:a.hierarchyCode,explain:a.explain};a.osmdocCat&&(a.osmdocCat.features||a.osmdocCat.groups)&&(h.poiclass=a.osmdocCat.features,h.poigroup=a.osmdocCat.groups);a.strictSearch&&(h.strict=!0);a.searchAddressesOnly&&(h.only_address=!0);e.pagesCenter&&(h.lat=e.pagesCenter.lat,h.lon=e.pagesCenter.lng);
f.get(API_ROOT+"/location/_search",{params:h}).success(function(d){e.searchSuccess.apply(e,[a,d])})}},searchSuccess:function(b,d){if("success"==d.result){var h=this.getHash(b);if(d.mark==h){a.closePopUP(b,b.activeFeatureID);b.searchResultsPage&&b.searchResultsPage.features&&angular.forEach(b.searchResultsPage.features,function(d){a.remove(b,d.feature_id)});b.searchResultsPage=d;b.getSRPages();var f=[];angular.forEach(d.features,function(d,e){a.createPopUP(b,d,d.feature_id);f.push(d.center_point)});
e.resetMap&&f&&0<f.length&&a.map.fitBounds(L.latLngBounds(f))}}},suggest:function(a){if(a.searchForm.q&&!(3>a.searchForm.q.length)&&(e.selectedSuggestion=-1,a.selectedSuggestion=-1,!e.waitForAnswer)){e.waitForAnswer=!0;var d={q:a.searchForm.q,size:10,mark:this.getHash(a),hierarchy:a.hierarchyCode};a.strictSearch&&(d.strict=!0);a.searchAddressesOnly&&(d.only_address=!0);f.get(API_ROOT+"/location/_suggest",{params:d}).success(function(d){e.waitForAnswer=!1;e.searchSuccess.apply(e,[a,d])})}},listPOI:function(b,
d){if(0!=g.cathegories.features.length||0!=g.cathegories.groups)e.restrictWithBBOX=!0,f.get(API_ROOT+"/location/_search",{params:{q:b.searchForm.q,poiclass:g.cathegories.features,poigroup:g.cathegories.groups,bbox:a.map.getBounds().toBBoxString(),size:20,page:d,mark:e.getHash(b),hierarchy:b.hierarchyCode}}).success(function(a){"success"==a.result&&e.listPOISuccess.apply(e,[a,b])})},listPOISuccess:function(b,d){var h=e.getHash(d);b.mark==h&&(angular.forEach(b.features,function(b,e){a.createPopUP(d,
b)}),b.page*b.size<b.hits&&10>b.page&&e.listPOI(d,b.page+1))},getHash:function(a){return(""+{poiclass:a.osmdocCat.features,poigroup:a.osmdocCat.groups,query:a.searchForm.q}).hashCode()},listPages:function(a){var d={};if(a.searchResultsPage){var e=a.searchResultsPage.hits,f=a.searchResultsPage.page,g=a.searchResultsPage.size,m=parseInt(e/g);0==e%g&&(m+=1);for(e=1;e<=m&&8>=e;e++)d[e]={p:e,active:f==e};for(e=f-1;e<=f+1;e++)0<e&&e<=m&&(d[e]={p:e,active:f==e});for(e=m-2;e<=m;e++)0<e&&(d[e]={p:e,active:f==
e})}var k=[];angular.forEach(d,function(a){k.push(a)});k.sort(function(a,b){return a.p-b.p});a.srPages=k},moveUp:function(a){e.selectedSuggestion--; -1>=e.selectedSuggestion&&(e.selectedSuggestion=-1);if(-1==e.selectedSuggestion)a.searchForm.q=e.userSearchInput,a.selectedSuggestion=null,a.suggestedFeature=null;else{var d=a.searchResultsPage.matched_type.slice(0),d=d.concat(a.searchResultsPage.features);a.searchForm.q.split(/[\s,;.]+/);var d=d[e.selectedSuggestion],f=e.getToken(d),g=" "===e.queryHead.slice(-1)?
"":" ",f=e.queryHead+g+f,f=" "===f.slice(-1)?f:f+" ";e.suppressOnSearchQuerry=!0;a.searchForm.q=f;a.selectedSuggestion=e.getId(d);a.suggestedFeature=d}},moveDown:function(a){var d=a.searchForm.q.split(/[\s,;.]+/);-1==e.selectedSuggestion&&(e.userSearchInput=a.searchForm.q,d.pop(),e.queryHead=d.join(" "));d=a.searchResultsPage.matched_type.slice(0);d=d.concat(a.searchResultsPage.features);e.selectedSuggestion++;e.selectedSuggestion>=d.length&&(e.selectedSuggestion=d.length-1);var d=d[e.selectedSuggestion],
f=e.getToken(d),g=" "===e.queryHead.slice(-1)?"":" ",f=e.queryHead+g+f,f=" "===f.slice(-1)?f:f+" ";e.suppressOnSearchQuerry=!0;a.searchForm.q=f;a.selectedSuggestion=e.getId(d);a.suggestedFeature=d},getToken:function(a){return a.type?a.name||a.housenumber:a.translated_title[0]},getId:function(a){return a.feature_id||a.name}};return e}]);var meOSMDoc=angular.module("meOSMDoc",["meMap"]);
(function(f,a){function g(a,b,d){angular.forEach(a.features,function(a){b.feature&&b.feature(a,d)});angular.forEach(a.groups,function(a){d.push(a.name);b.group&&b.group(a);g(a,b,d);d.pop(a.name)})}a.factory("docTree",["$http","mapService",function(a,b){var d={SUPPORTED_HIERARCHIES:["osm-ru"],cathegories:{features:[],groups:[]},attach:function(a){a.osmdocCat=d.cathegories;a.expand=function(a){a.expanded=!a.expanded};a.selectPoiType=function(b){d.selectPoiType.apply(d,[a,b])};a.selectCathegory=function(e,
f){e.selected?d.addSelection.apply(d,[a,e,f]):d.removeSelection.apply(d,[a,e,f]);var g=d.expandCathegories.apply(d,[a]);b.filterMarkersByTypes.apply(b,[a,g])};a.listMoreTags=function(b){if(!b||!a.name2FClass)return null;if(b.__translatedTags&&0<b.__translatedTags.length)return b.__translatedTags;var e=b.poi_class,d=[];angular.forEach(b.more_tags,function(b,f){for(var g in e){var l={},n=a.name2FClass[e[g]];n&&(n=n.more_tags[f])&&(l.name=n.name,l.type=n.valueType,l.key=f,n.values[b]?(l.value=n.values[b].name,
l.group=n.values[b].group):l.value=b,d.push(l))}});return b.__translatedTags=d}},selectPoiType:function(a,b){this.addSelection(a,a.name2FClass[b],"features")},loadTree:function(b,d,f){a.get(API_ROOT+"/osmdoc/hierarchy/"+d+"/"+f).success(function(a){b.hierarchy=a;g(b.hierarchy,{feature:function(a){b.name2FClass[a.name]=a},group:function(a){b.name2Group[a.name]=a}},[]);b.$broadcast("HierarchyLoaded")})},expandCathegories:function(a){if(!a.hierarchy)return[];var b={};f.forEach(this.cathegories.features,
function(a){b[a]=1});var d=this;g(a.hierarchy,{feature:function(a,e){f.forEach(d.cathegories.groups,function(d){0<=e.indexOf(d)&&(b[a.name]=1)})}},[]);var e=[];f.forEach(b,function(a,b){e.push(b)});return e},addSelection:function(a,b,d){d=this.cathegories[d];b&&d&&d.push(b.name);a.$broadcast("SelectCathegoryTreeNode")},removeSelection:function(a,b,d){d=this.cathegories[d];if(b&&d)for(var e=0;e<d.length;e++)if(d[e]==b.name){d.splice(e,1);break}a.$broadcast("UnselectCathegoryTreeNode")},updateSelections:function(a){g(a.hierarchy,
{group:function(a){a.selected=0<=d.cathegories.groups.indexOf(a.name)},feature:function(a,b){a.selected=0<=d.cathegories.features.indexOf(a.name)}},[])},getHierarchyCode:function(a){a="osm-"+a;return 0>d.SUPPORTED_HIERARCHIES.indexOf(a)?d.SUPPORTED_HIERARCHIES[0]:a},organizeCathegories:function(){d.cathegories.groups=filterAndSort(d.cathegories.groups);d.cathegories.features=filterAndSort(d.cathegories.features)}};return d}])})(angular,meOSMDoc);var meDetails=angular.module("meDetails",["meMap","meI18n"]);
meDetails.factory("details",["$http","mapService","i18nService",function(f,a,g){var e={cache:new FixedSizeFIFOCache,showPopup:function(b,d){a.isPopUPExists(b,d)?a.openPopUP(b,d):d&&(this.cache.get(d)?(a.createPopUP(b,this.cache.get(d)),a.openPopUP(b,d)):this._load(b,d,!1,function(e){a.createPopUP(b,e);a.openPopUP(b,d)}))},closePopup:function(b,d){d&&a.isPopUPExists(b,d)&&a.closePopUP(b,d)},showDetails:function(a,d){d&&(a.moreLikeThis=null,this.cache.get(d)&&this.cache.get(d)._related?(a.objectDetails=
this.cache.get(d),a.content="details",a.moreLikeThisH4=g.tr(a,"details.poi.more").format((a.formatObjectType(a.objectDetails)||"").toLowerCase())):this._load(a,d,!0,function(d){a.objectDetails=d;a.content="details";a.moreLikeThisH4=g.tr(a,"details.poi.more").format((a.formatObjectType(a.objectDetails)||"").toLowerCase())}))},_load:function(b,d,g,l){var q=API_ROOT+"/location/"+d;g&&(q+="/_related");f.get(q).success(function(f){function g(b,d){a.ready?h(b,d):window.setTimeout(function(){g(b,d)},500)}
function h(a,b){e.cache.put.apply(e.cache,[d,b]);l(b)}f&&f.feature_id&&g(b,f)})}};return e}]);FixedSizeFIFOCache=function(f){this.size=f||20;this.storage={};this.queue={};this.pointer=0};FixedSizeFIFOCache.prototype.inc=function(){this.pointer+=1;this.pointer==this.size&&(this.pointer=0)};FixedSizeFIFOCache.prototype.put=function(f,a){this.storage[f]?this.storage[f]=a:(this.storage[f]=a,delete this.storage[this.queue[this.pointer]],this.inc())};FixedSizeFIFOCache.prototype.get=function(f){return this.storage[f]};
