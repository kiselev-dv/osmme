function whTableSpan(g){var b=[],h;for(h in g)b.push(g[h][1]);for(h=0;h<b.length;h++){var e;a:{e=0;for(var d=h+1;d<b.length;d++){if(b[d].text!=b[h].text)break a;e++}}if(e){b[h].rspan=e;for(d=1;d<=e;d++)g[h+d][1]=null;h+=e}}}
function tagValueHTML(g){if(!0===g.value)return i18nService.tr($scope,"details.poi.tag.values.true");if(!1===g.value)return i18nService.tr($scope,"details.poi.tag.values.false");if("contact:website"==g.key)return'<a href="'+g.value+'">'+g.value+"</a>";if("opening_hours"==g.key){if(g.value["24_7"])return i18nService.tr($scope,"details.poi.tag.values.wh.24_7");g=getWHTable($scope,g,i18nService);whTableSpan(g);return 6==g[0][1].rspan?i18nService.tr($scope,"details.poi.tag.values.wh.evryday")+g[0][1].text:
whTableHTML(g)}return g.value}function whTableHTML(g){var b="<table>",h;for(h in g){var b=b+"<tr>",e;for(e in g[h]){var d=g[h][e];d&&(b+="<td",d.cspan&&(b+=' colspan="'+d.cspan+'"'),d.rspan&&(b+=' rowspan="'+d.rspan+'"'),b+=">",b+=d.text+"</td>")}b+="</tr>"}return b+"</table>"}
function getWHTable(g,b,h){var e=[],d="MO TU WE TH FR SA SU".split(" "),f;for(f in d){var k=[];e.push(k);var m=b.value[d[f]];k.push({text:g.dayNames[f]});m?m[2]?k.push({text:m[0]+"-"+m[m.length-1]+"<br>"+m[1]+"-"+m[2]}):k.push({text:m[0]+"-"+m[1]}):k.push({text:h.tr(g,"details.poi.tag.values.wh.off")})}return e}
function getAddress(g,b){if(!g)return[""];var h=!0;g.addresses&&g.addrTexts&&(h=g.addresses.length==g.addrTexts.length);if(g.addrTexts&&h)return g.addrTexts;g.address?(h=getAddrArray(g),"city-street-hn"==b&&h.reverse(),g.addrTexts=[h.join(", ")]):g.addresses&&(g.addrTexts=[],angular.forEach(g.addresses,function(e){e=getAddrArray(e);"city-street-hn"==b&&e.reverse();g.addrTexts.push(e.join(", "))}));return g.addrTexts}
function getAddrArray(g){var b=[];g.housenumber&&g.housenumber[0]&&b.push(g.housenumber[0]);g.street_name&&b.push(g.street_name);g.neighborhood_name?b.push(g.neighborhood_name):g.nearest_neighbour&&b.push(g.nearest_neighbour.name);g.locality_name?b.push(g.locality_name):g.nearest_place&&b.push(g.nearest_place.name);g.local_admin_name&&ADDR_LOCAL_ADMIN&&b.push(g.local_admin_name);g.admin2_name&&ADDR_ADMIN2&&b.push(g.admin2_name);g.admin1_name&&ADDR_ADMIN1&&b.push(g.admin1_name);g.admin0_name&&ADDR_ADMIN0&&
b.push(g.admin0_name);return b=merdgeAddrLevels(b)}function merdgeAddrLevels(g){for(var b=[g[0]],h=1;h<g.length;h++)0>g[h-1].indexOf(g[h])&&0>g[h].indexOf(g[h-1])&&b.push(g[h]);return b};String.prototype.hashCode=function(){var g=0;if(0==this.length)return g;for(i=0;i<this.length;i++)c=this.charCodeAt(i),g=(g<<5)-g+c,g&=g;return g};String.prototype.format=function(){var g=arguments;return this.replace(/{(\d+)}/g,function(b,h){return"undefined"!=typeof g[h]?g[h]:b})};var OSMmeApp=angular.module("OSMmeApp","ngCookies ngSanitize meMap meI18n angular-google-analytics meSearch meOSMDoc meIGeocoder meDetails meRouter ngDisqus".split(" "));OSMmeApp.config(["$locationProvider",function(g){g.hashPrefix("!")}]);
ANALYTICS_CODE&&OSMmeApp.config(["AnalyticsProvider",function(g){g.setAccount(ANALYTICS_CODE)}]);OSMmeApp.directive("ngEnter",function(){return function(g,b,h){b.bind("keydown keypress",function(b){13===b.which&&(g.$apply(function(){g.$eval(h.ngEnter)}),b.preventDefault())})}});
OSMmeApp.directive("meResize",["$window",function(g){return function(b,h){var e=angular.element(g);b.getWindowDimensions=function(){var b=document.body,f=document.documentElement,e=Math.max(b.scrollHeight,b.offsetHeight,f.clientHeight,f.scrollHeight,f.offsetHeight),b=Math.max(b.scrollWidth,b.offsetWidth,f.clientWidth,f.scrollWidth,f.offsetWidth);return{h:e,w:b}};b.$watch(b.getWindowDimensions,function(d,e){b.windowHeight=d.h;b.windowWidth=d.w},!0);e.bind("resize",function(){b.$apply()})}}]);
OSMmeApp.controller("MapController",["$rootScope","$scope","$cookies","i18nService","mapService","search","docTree","details","iGeocoder","$location","routeService","Analytics",function(g,b,h,e,d,f,k,m,r,n,l,q){function v(){var d=l.getParameters(),e=[],f=[];d.pg&&d.pg.split(",").forEach(function(b){b&&e.push(b)});d.pt&&d.pt.split(",").forEach(function(b){b&&f.push(b)});e=filterAndSort(e);f=filterAndSort(f);!b.osmdocCat||angular.equals(e,b.osmdocCat.groups)&&angular.equals(f,b.osmdocCat.features)||
(b.osmdocCat.groups=e,b.osmdocCat.features=f,k.organizeCathegories(),k.updateSelections(b),b.$broadcast("SelectCathegoryTreeNode"))}b.HTML_ROOT=HTML_ROOT;g.HTML_ROOT=HTML_ROOT;ANALYTICS_CODE&&q.trackPage("/#!/"+b.lng+"/");b.mobile=800>(0<window.innerWidth?window.innerWidth:screen.width);g=n.search();l.anonymous("lang");l.parameter("id");l.parameter("map",3,!0);l.parameter("pg");l.parameter("pt");l.parameter("q");l.flag("strict");l.flag("details");l.flag("explain");if(g.fid){var t={};t.id=g.fid;g.details&&
(t.details=!0);n.search("");n.path("");l.update(t)}var p=l.getParameters();p.lang||l.update("lang",initLang(h));b.lng=p.lang||initLang(h);b.hierarchyCode=k.getHierarchyCode(b.lng);b.langsAvaible=["en","ru"];b.name2FClass={};b.name2Group={};k.loadTree(b,b.lng,b.hierarchyCode);e.getTranslation(b,b.lng,!0,function(){var g=[null,null,null];p.map&&(g=p.map);var l=d.createMap(b,g[1],g[2],g[0]);r.create(b,l);k.attach(b);f.attach(b);b.dayNames=e.tr(b,"details.poi.tag.values.wh.days").split(" ");d.enquirePosition(function(d){if(d){var e=
d.coords.latitude,f=d.coords.longitude;500<l.getCenter().distanceTo([e,f])&&r.sendRequest(f,e,!1,function(d){d&&d.text?(d.lat=e,d.lon=f,b.browserGeoLocation=d):b.browserGeoLocation&&delete b.browserGeoLocation})}})});b.activeFeatureID=p.fid;b.explain=p.explain;b.content=p.details?"details":"map";b.activeFeatureID&&("details"==b.content?m.showDetails(b,b.activeFeatureID):m.showPopup(b,b.activeFeatureID));b.$on("$locationChangeSuccess",function(){var e=b.activeFeatureID,f=l.getParameters();b.lng!=f.lang&&
(h.lang=f.lang,l.reload());b.activeFeatureID=f.id;b.explain=f.explain;b.content=f.details?"details":"map";"details"==b.content?(ANALYTICS_CODE&&q.trackPage("/#!/"+b.lng+"/id/"+b.activeFeatureID+"/details"),m.showDetails(b,b.activeFeatureID),e&&m.closePopup(b,e)):(b.activeFeatureID?(ANALYTICS_CODE&&q.trackPage("/#!/"+b.lng+"/id/"+b.activeFeatureID),m.showPopup(b,b.activeFeatureID)):void 0!==e&&e!=b.activeFeatureID&&m.closePopup(b,e),l.getParameters().map&&(e=l.getParameters().map,d.broadcastAction||
d.setView(e[1],e[2],e[0])));f.strict&&(b.strictSearch=!0);f.q&&null==b.searchQuerry&&b.searchQuerry!=f.q&&(b.searchQuerry=f.q,b.$broadcast("Search",f.q));v()});b.$on("Search",function(){l.update("q",b.searchQuerry)});b.$on("SelectFeature",function(){l.update("q",b.searchQuerry)});b.$on("HierarchyLoaded",v);b.$on("PopupClose",function(d,e){"map"==b.content&&l.update("id",null)});b.$on("PopupOpen",function(b,d){l.update({id:d,map:null})});b.$on("MapViewChanged",function(){l.update("map",d.getStateArray())});
n=function(){b.osmdocCat&&(k.organizeCathegories(),0<b.osmdocCat.features.length?l.update("pt",b.osmdocCat.features.join()):l.update("pt",null),0<b.osmdocCat.groups.length?l.update("pg",b.osmdocCat.groups.join()):l.update("pg",null),d.filterMarkersByTypes(b,k.expandCathegories(b)),k.updateSelections(b))};b.$on("CloseSearchResults",function(){b.searchQuerry="";b.searchResultsPage=null;b.srPages=null;d.filterMarkersByTypes(b,k.expandCathegories(b));k.updateSelections(b)});b.$on("SelectCathegoryTreeNode",
n);b.$on("UnselectCathegoryTreeNode",n);b.formatObjectType=function(d){if(d){if(d.poi_class){var f=b.translateTypeNames(d);if(0<f.length)return f.join(", ")}if(d.weight_base_type)return e.tr(b,"weight_base_type."+d.weight_base_type)}return null};b.translateTypeNames=function(d){var f=[];if(d&&d.poi_class)for(var e in d.poi_class){var k=d.poi_class[e];b.name2FClass&&b.name2FClass[k]&&(k=b.name2FClass[k].translated_title,k.toUpperCase()!==(d.name||"").toUpperCase()&&f.push(k))}return f};b.nameContainsType=
function(d){if(d){var f=b.translateTypeNames(d);d=(d.name||"").toLowerCase();for(var e in f)if(0<=d.indexOf(f[e].toLowerCase()))return!0}return!1};b.tagValueHTML=tagValueHTML;b.buildingType=function(d){return e.tr(b,"details.adr.building")};b.mergeIntoPath=function(d,b){return"/#!"+l.mergeIntoPath(d,b)};b.searchKeyDown=function(d){38==d.keyCode?(d.stopPropagation(),d.preventDefault(),b.$broadcast("SearchKeyUp")):40==d.keyCode&&b.$broadcast("SearchKeyDown")};b.$watch("searchQuerry",function(d,f){""!=
f&&""==d&&b.$broadcast("CleanSearchInput")});b.$on("CleanSearchInput",function(){l.update("q",null)});b.formatSearchResultTitle=function(d){if(!d)return"";if("adrpnt"==d.type)return e.tr(b,"map.js.search.title.adrpnt");if(d.name||d.poi_class){var f=b.formatObjectType(d),k=d.name||f;d.name&&f&&(k+=" ("+f+")");return k}return""};b.formatSearchResultAddress=function(d){return d?getAddress(d,b.translation?b.translation["addr.order"]:"hn-street-city")[0]:""};b.getAddress=function(d){return getAddress(d,
b.translation?b.translation["addr.order"]:"hn-street-city")};b.selectRow=function(d){b.$broadcast("SelectFeature",d)};b.searchInputEnter=function(){b.suggestedFeature?b.suggestedFeature.feature_id?b.$broadcast("SelectFeature",b.suggestedFeature):b.selectPoiType(b.suggestedFeature.name):b.$broadcast("Search",b.searchQuerry)};b.removeSelected=function(d,f){k.removeSelection(b,{name:d},f)};b.moveToBrowserGeoLocation=function(b){d.setView(b.lat,b.lon,14);d.saveStateToCookie()}}]);
function initLang(g){return g.lang?g.lang:"en-US"===(window.navigator.language||window.navigator.userLanguage)?"en":"ru"}disqus_shortname="osmme";var router=angular.module("meRouter",[]);
router.factory("routeService",["$location",function(g){function b(){this.parameters=[];this.byName={}}b.prototype.parameter=function(b,e,d,f){e={name:b,type:"parameter",escape:f||!0,slashes:e||0,skipSave:d||!1};this.byName[b]||(this.parameters.push(e),this.byName[b]=e)};b.prototype.anonymous=function(b,e,d,f){e={name:b,type:"anonymous",escape:f||!0,skipSave:d||!1};this.byName[b]||(this.parameters.push(e),this.byName[b]=e)};b.prototype.flag=function(b,e){var d={name:b,type:"flag",skipSave:e||!1};this.byName[b]||
(this.parameters.push(d),this.byName[b]=d)};b.prototype.template=function(){var b="/";angular.forEach(this.parameters,function(e){"anonymous"==e.type&&(b+=":"+e.name+"/");"flag"==e.type&&(b+="?"+e.name+"/");if("parameter"==e.type&&(b+=e.name+"/:"+e.name+"/",e.slashes))for(var d=0;d<e.slashes-1;d++)b+=":"+e.name+"/"});return b};b.prototype.getParameters=function(){var b=[];angular.forEach(g.path().split("/"),function(d){d&&b.push(d)});for(var e=0,d={},f=0;f<b.length;f++)for(var k=e;k<this.parameters.length;k++){var m=
this.parameters[k],r=b[f];if("anonymous"==m.type){d[m.name]=r;e++;break}else if("flag"==m.type&&m.name==r){d[m.name]=!0;e++;break}else if("parameter"==m.type&&m.name==r){if(m.slashes)for(k=f+1;k<Math.min(b.length,f+1+m.slashes);k++)d[m.name]||(d[m.name]=[]),d[m.name].push(b[k]);else d[m.name]=b[f+1];f+=m.slashes||1;e++;break}}return d};b.prototype.createPath=function(b){for(var e="/",d=0;d<this.parameters.length;d++){var f=this.parameters[d];"anonymous"==f.type&&b[f.name]&&(e+=b[f.name]+"/");"flag"==
f.type&&b[f.name]&&(e+=f.name+"/");if("parameter"==f.type&&b[f.name])if(e+=f.name+"/",f.slashes)for(var k=0;k<f.slashes;k++)e+=b[f.name][k]+"/";else e+=b[f.name]+"/"}return e};b.prototype.update=function(b,e,d){var f={};void 0===e&&void 0===d?f=b:f[b]=e;e=angular.extend(this.getParameters(),f);e=this.createPath(e);e=g.path(e);this.byName[b]&&this.byName[b].skipSave&&!d&&e.replace();return e};b.prototype.mergeIntoPath=function(b,e){var d={};void 0===e?d=b:d[b]=e;d=angular.extend(this.getParameters(),
d);return this.createPath(d)};b.prototype.reload=function(){window.location.reload()};return new b}]);var MapModule=angular.module("meMap",["ngCookies","meI18n"]);
(function(g,b){function h(b,d){var f=Math.pow(10,d);return Math.round(b*f)/f}b.factory("mapService",["i18nService","$rootScope","$cookies","$compile","$http",function(b,d,f,k,g){var r=L.Control.extend({container:null,options:{position:"topleft"},setScope:function(b){this.scope=b;return this},setContainer:function(b){var d=L.DomUtil.create("div","search-control");L.DomEvent.disableClickPropagation(d);L.DomEvent.addListener(d,"mousewheel",function(b){var d=document.getElementById("r-scroll-pane");d&&
(d.scrollTop-=20*L.DomEvent.getWheelDelta(b));L.DomEvent.stopPropagation(b)});d.innerHTML=b;this.container=d},onAdd:function(b){return this.container}}),n={id2Feature:{},id2Marker:{},ready:!1,createMap:function(l,q,h,t){q=q||f.lat||DEFAULT_LAT;if(90<q||-90>q)q=DEFAULT_LAT;h=h||f.lon||DEFAULT_LON;if(180<h||-180>h)h=DEFAULT_LON;t=t||f.z||DEFAULT_ZOOM;0>=t&&(t=DEFAULT_ZOOM);this.map=L.map("map",{zoomControl:!1}).setView([q,h],t);q=b.tr(l,"map.js.copy.data")+' &copy; <a href="http://osm.org">'+b.tr(l,
"map.js.copy.contributors")+"</a>, "+b.tr(l,"map.js.copy.rendering")+' <a href="http://giscience.uni-hd.de/" target="_blank">University of Heidelberg</a>';q=L.tileLayer("http://openmapsurfer.uni-hd.de/tiles/roads/x={x}&y={y}&z={z}",{attribution:q,maxZoom:18}).addTo(this.map);h=b.tr(l,"map.js.copy.contributors")+'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a>';t=L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:h});h={};h[b.tr(l,"map.js.layer.relief")]=L.tileLayer("http://openmapsurfer.uni-hd.de/tiles/asterh/x={x}&y={y}&z={z}",
{maxZoom:18});h[b.tr(l,"map.js.layer.contours")]=L.tileLayer("http://openmapsurfer.uni-hd.de/tiles/asterc/x={x}&y={y}&z={z}",{maxZoom:18});q={Mapnik:t,MapSurfer:q};l.mobile||(this.layersControl=L.control.layers(q,h),this.layersControl.addTo(this.map));var p=this.map;this.map.on("viewreset",function(){window.setTimeout(function(){n.saveStateToCookie.apply(n,[]);n.broadcastAction=!0;l.$broadcast("MapViewChanged",p.getCenter(),p.getZoom());d.$$phase||d.$apply();n.broadcastAction=!1},10)});this.map.on("moveend",
function(){window.setTimeout(function(){n.saveStateToCookie.apply(n,[]);n.broadcastAction=!0;l.$broadcast("MapViewChanged",p.getCenter(),p.getZoom());d.$$phase||d.$apply();n.broadcastAction=!1},10)});this.map.on("popupopen",function(b){var f=p.project(b.popup._latlng);f.y-=b.popup._container.clientHeight/2;p.panTo(p.unproject(f),{animate:!1});l.$broadcast("PopupOpen",b.popup._source?b.popup._source.feature_id:b.popup.feature_id);d.$$phase||d.$apply()});this.map.on("popupclose",function(b){l.$broadcast("PopupClose",
b.popup._source?b.popup._source.feature_id:b.popup.feature_id);d.$$phase||d.$apply()});this.ready=!0;var u=this.searchControl=(new r).setScope(l);g.get(HTML_ROOT+"/templates/search_control.html").success(function(b){u.setContainer(b);u.addTo(p);k(u.container)(l)});return this.map},createPopUP:function(b,d){if(!this.id2Feature[d.feature_id]){this.id2Feature[d.feature_id]=d;var f=d.poi_class?b.name2FClass[d.poi_class[0]]:null,e=this;this.loadIcon(f,function(){var k=L.marker([d.center_point.lat,d.center_point.lon]);
f&&f.ll_icon&&(k=L.marker([d.center_point.lat,d.center_point.lon],{icon:f.ll_icon}));e.id2Marker[d.feature_id]=k;k.addTo(e.map).bindPopup(e.getPopUPHtml(d,d.feature_id,b));k.feature_id=d.feature_id})}},openPopUP:function(b,d,f){if(d&&this.id2Marker[d])if(angular.element(this.map.getContainer()).hasClass("ng-hide")){var e=this,k=f||5;0<k&&window.setTimeout(function(){e.openPopUP.apply(e,[b,d,k])},100)}else this.id2Marker[d]._popup._isOpen||(this.map.invalidateSize(!1),this.id2Marker[d].openPopup())},
closePopUP:function(b,d){d&&this.id2Marker[d]&&this.id2Marker[d].closePopup()},isPopUPExists:function(b,d){return d&&!!this.id2Marker[d]},getPopUPHtml:function(d,f,k){var g=k.formatSearchResultTitle(d);d=getAddress(d,k.translation?k.translation["addr.order"]:"hn-street-city")[0];f='<a class="more-link" href="'+k.mergeIntoPath({details:!0,id:f})+'">'+b.tr(k,"map.js.popup.more")+"</a>";return g?'<div class="fpopup"><h2>'+g+"</h2><div>"+d+"</div><div>"+f+"</div>":"<div>"+d+"</div>"+f},remove:function(b,
d){void 0!==this.id2Feature[d]&&(this.id2Marker[d]&&(this.map.removeLayer(this.id2Marker[d]),delete this.id2Marker[d]),delete this.id2Feature[d],b.activeFeatureID=null)},clearAllMarkers:function(b){this.filterMarkersByTypes(b,[])},filterMarkersByTypes:function(b,d){var f=[];angular.forEach(this.id2Feature,function(b,e){0>d.indexOf(b.class_name)&&f.push(e)});angular.forEach(f,function(d){n.remove.apply(n,[b,d])})},getStateString:function(){var b=this.map.getCenter(),d=this.map.getZoom();return 0<d&&
90>b.lat&&-90<b.lat&&-180<b.lng&&180>b.lng?d+"/"+h(b.lat,5)+"/"+h(b.lng,5):null},getStateArray:function(){var b=this.map.getCenter(),d=this.map.getZoom();return 0<d&&90>b.lat&&-90<b.lat&&-180<b.lng&&180>b.lng?[d,h(b.lat,5),h(b.lng,5)]:null},saveStateToCookie:function(){var b=this.map.getCenter(),d=this.map.getZoom();0<d&&90>b.lat&&-90<b.lat&&-180<b.lng&&180>b.lng&&(f.lat=b.lat,f.lon=b.lng,f.z=d)},setView:function(b,d,f){0<f&&90>b&&-90<b&&-180<d&&180>d&&this.map&&this.map.setView([b,d],f)},enquirePosition:function(b){"geolocation"in
navigator&&navigator.geolocation.getCurrentPosition(b)},imgWaiters:{},loadIcon:function(b,d){if(b)if(void 0===b.ll_icon){var f=TYPE_ICONS_ROOT+"/"+b.icon;if(void 0===this.imgWaiters[f]){thisClosure=this;this.imgWaiters[f]=[];this.imgWaiters[f].push(d);var e=new Image;e.onload=function(){b.ll_icon=L.icon({iconUrl:f,iconSize:[32,37],iconAnchor:[16,37],popupAnchor:[0,-38]});for(var d=0;d<thisClosure.imgWaiters[f].length;d++)thisClosure.imgWaiters[f][d]();thisClosure.imgWaiters[f]=null};e.onerror=function(){b.ll_icon=
null;for(var d=0;d<thisClosure.imgWaiters[f].length;d++)thisClosure.imgWaiters[f][d]();thisClosure.imgWaiters[f]=null};e.src=f}else null===this.imgWaiters[f]?d():this.imgWaiters[f].push(d)}else d();else d()}};return n}])})(angular,MapModule);var meI18n=angular.module("meI18n",["ngResource"]);
meI18n.factory("i18nService",["$resource",function(g){return{getTranslation:function(b,h,e,d){var f=HTML_ROOT+"/i18n/map_"+h+".json",k="map.js_"+h;sessionStorage&&!e?sessionStorage.getItem(k)?(b.translation=JSON.parse(sessionStorage.getItem(k)),d&&d()):g(f).get(function(f){b.translation=f;sessionStorage.setItem(k,JSON.stringify(b.translation));d()}):g(f).get(function(f){b.translation=f;d()})},tr:function(b,g){return void 0!==b.translation&&void 0!==b.translation[g]?b.translation[g]:g}}}]);var meIGeocoder=angular.module("meIGeocoder",["ngResource","meMap","meDetails"]);
(function(g,b){b.factory("iGeocoder",["$http","mapService","details",function(b,e,d){return{create:function(b,d){var g=this;d.on("click",function(b){14<d.getZoom()&&g.sendRequest(b.latlng.lng,b.latlng.lat)});this.scope=b;b.$on("CloseInverseGeocodeResults",function(){b.inverseGeocodeResults=null;e.filterMarkersByTypes(b,[])})},sendRequest:function(d,e,g,r){var n=this;d=API_ROOT+"/location/latlon/"+e+"/"+d;if(void 0==g||g)d+="/_related";void 0==r?b.get(d).success(function(b){n.showAnswer.apply(n,[b])}):
b.get(d+"?largest_level=all&max_neighbours=0&full_geometry=false").success(r)},showAnswer:function(b){if(b&&b.feature_id){this.scope.$broadcast("CloseSearchResults",b.feature_id);this.scope.inverseGeocodeResults=b;var d=this.scope;e.createPopUP(d,b);b._related&&b._related._same_building&&angular.forEach(b._related._same_building,function(b){e.createPopUP(d,b)});b._eclosed&&angular.forEach(b._eclosed,function(b){e.createPopUP(d,b)});b._neighbours&&angular.forEach(b._neighbours,function(b){e.createPopUP(d,
b)})}}}}])})(angular,meIGeocoder);var meSearch=angular.module("meSearch",["meMap","meOSMDoc"]);
meSearch.factory("search",["$http","mapService","docTree",function(g,b,h){var e={resetMap:!1,selectedSuggestion:-1,queryHead:null,userSearchInput:"",restrictWithBBOX:!1,suggestTimer:null,attach:function(d){d.$on("MapViewChanged",function(b){e.pagesMode||e.listPOI.apply(e,[d,1])});d.$on("SelectCathegoryTreeNode",function(){d.searchQuerry="";d.searchResultsPage={};e.pagesMode=!1;e.listPOI.apply(e,[d,1])});d.$on("UnselectCathegoryTreeNode",function(){e.pagesMode=!1;e.listPOI.apply(e,[d,1])});d.$on("Search",
function(){e.pagesCenter=b.map.getCenter();e.search.apply(e,[d,1])});d.$on("SearchKeyUp",function(){e.moveUp.apply(e,[d])});d.$on("SearchKeyDown",function(){e.moveDown.apply(e,[d])});d.$on("SelectFeature",function(f,e){b.openPopUP(d,e.feature_id)});d.$watch("searchQuerry",function(b,k){e.suppressOnSearchQuerry?e.suppressOnSearchQuerry=!1:(e.suggestTimer&&window.clearTimeout(e.suggestTimer),e.suggestTimer=window.setTimeout(function(){e.suggest(d)},300))});d.searchResultsPage={};d.getSRPages=function(){e.listPages(d)};
d.goPage=function(b){e.search(d,b.p)}},search:function(b,f){e.restrictWithBBOX=!1;e.userSearchInput="";if(b.searchQuerry){var k={q:b.searchQuerry,mark:e.getHash(b),page:f,hierarchy:b.hierarchyCode,explain:b.explain};b.osmdocCat&&(b.osmdocCat.features||b.osmdocCat.groups)&&(k.poiclass=b.osmdocCat.features,k.poigroup=b.osmdocCat.groups);b.strictSearch&&(k.strict=!0);b.searchAddressesOnly&&(k.only_address=!0);e.pagesCenter&&(k.lat=e.pagesCenter.lat,k.lon=e.pagesCenter.lng);g.get(API_ROOT+"/location/_search",
{params:k}).success(function(f){e.searchSuccess.apply(e,[b,f])})}},searchSuccess:function(d,f){if("success"==f.result){var k=this.getHash(d);if(f.mark==k){b.closePopUP(d,d.activeFeatureID);d.searchResultsPage&&d.searchResultsPage.features&&angular.forEach(d.searchResultsPage.features,function(f){b.remove(d,f.feature_id)});d.searchResultsPage=f;d.getSRPages();var g=[];angular.forEach(f.features,function(f,e){b.createPopUP(d,f,f.feature_id);g.push(f.center_point)});e.resetMap&&g&&0<g.length&&b.map.fitBounds(L.latLngBounds(g))}}},
suggest:function(b){if(b.searchQuerry&&!(3>b.searchQuerry.length)&&(e.selectedSuggestion=-1,b.selectedSuggestion=-1,!e.waitForAnswer)){e.waitForAnswer=!0;var f={q:b.searchQuerry,size:10,mark:this.getHash(b),hierarchy:b.hierarchyCode};b.strictSearch&&(f.strict=!0);b.searchAddressesOnly&&(f.only_address=!0);g.get(API_ROOT+"/location/_suggest",{params:f}).success(function(f){e.waitForAnswer=!1;e.searchSuccess.apply(e,[b,f])})}},listPOI:function(d,f){if(0!=h.cathegories.features.length||0!=h.cathegories.groups)e.restrictWithBBOX=
!0,g.get(API_ROOT+"/location/_search",{params:{q:d.searchQuerry,poiclass:h.cathegories.features,poigroup:h.cathegories.groups,bbox:b.map.getBounds().toBBoxString(),size:20,page:f,mark:e.getHash(d),hierarchy:d.hierarchyCode}}).success(function(b){"success"==b.result&&e.listPOISuccess.apply(e,[b,d])})},listPOISuccess:function(d,f){var k=e.getHash(f);d.mark==k&&(angular.forEach(d.features,function(d,e){b.createPopUP(f,d)}),d.page*d.size<d.hits&&10>d.page&&e.listPOI(f,d.page+1))},getHash:function(b){return(""+
{poiclass:b.osmdocCat.features,poigroup:b.osmdocCat.groups,query:b.searchQuerry}).hashCode()},listPages:function(b){var f={};if(b.searchResultsPage){var e=b.searchResultsPage.hits,g=b.searchResultsPage.page,h=b.searchResultsPage.size,n=parseInt(e/h);0==e%h&&(n+=1);for(e=1;e<=n&&8>=e;e++)f[e]={p:e,active:g==e};for(e=g-1;e<=g+1;e++)0<e&&e<=n&&(f[e]={p:e,active:g==e});for(e=n-2;e<=n;e++)0<e&&(f[e]={p:e,active:g==e})}var l=[];angular.forEach(f,function(b){l.push(b)});l.sort(function(b,d){return b.p-d.p});
b.srPages=l},moveUp:function(b){e.selectedSuggestion--; -1>=e.selectedSuggestion&&(e.selectedSuggestion=-1);if(-1==e.selectedSuggestion)b.searchQuerry=e.userSearchInput,b.selectedSuggestion=null,b.suggestedFeature=null;else{var f=b.searchResultsPage.matched_type.slice(0),f=f.concat(b.searchResultsPage.features);b.searchQuerry.split(/[\s,;.]+/);var f=f[e.selectedSuggestion],g=e.getToken(f),h=" "===e.queryHead.slice(-1)?"":" ",g=e.queryHead+h+g,g=" "===g.slice(-1)?g:g+" ";e.suppressOnSearchQuerry=!0;
b.searchQuerry=g;b.selectedSuggestion=e.getId(f);b.suggestedFeature=f}},moveDown:function(b){var f=b.searchQuerry.split(/[\s,;.]+/);-1==e.selectedSuggestion&&(e.userSearchInput=b.searchQuerry,f.pop(),e.queryHead=f.join(" "));f=b.searchResultsPage.matched_type.slice(0);f=f.concat(b.searchResultsPage.features);e.selectedSuggestion++;e.selectedSuggestion>=f.length&&(e.selectedSuggestion=f.length-1);var f=f[e.selectedSuggestion],g=e.getToken(f),h=" "===e.queryHead.slice(-1)?"":" ",g=e.queryHead+h+g,g=
" "===g.slice(-1)?g:g+" ";e.suppressOnSearchQuerry=!0;b.searchQuerry=g;b.selectedSuggestion=e.getId(f);b.suggestedFeature=f},getToken:function(b){return b.type?b.name||b.housenumber:b.translated_title[0]},getId:function(b){return b.feature_id||b.name}};return e}]);var meOSMDoc=angular.module("meOSMDoc",["meMap"]);
(function(g,b){function h(b,d,f){angular.forEach(b.features,function(b){d.feature&&d.feature(b,f)});angular.forEach(b.groups,function(b){f.push(b.name);d.group&&d.group(b);h(b,d,f);f.pop(b.name)})}b.factory("docTree",["$http","mapService",function(b,d){var f={SUPPORTED_HIERARCHIES:["osm-ru"],cathegories:{features:[],groups:[]},attach:function(b){b.osmdocCat=f.cathegories;b.expand=function(b){b.expanded=!b.expanded};b.selectPoiType=function(d){f.selectPoiType.apply(f,[b,d])};b.selectCathegory=function(e,
g){e.selected?f.addSelection.apply(f,[b,e,g]):f.removeSelection.apply(f,[b,e,g]);var h=f.expandCathegories.apply(f,[b]);d.filterMarkersByTypes.apply(d,[b,h])};b.listMoreTags=function(d){if(!d||!b.name2FClass)return null;if(d.__translatedTags&&0<d.__translatedTags.length)return d.__translatedTags;var e=d.poi_class,f=[];angular.forEach(d.more_tags,function(d,g){for(var h in e){var m={},p=b.name2FClass[e[h]];p&&(p=p.more_tags[g])&&(m.name=p.name,m.type=p.valueType,m.key=g,p.values[d]?(m.value=p.values[d].name,
m.group=p.values[d].group):m.value=d,f.push(m))}});return d.__translatedTags=f}},selectPoiType:function(b,d){this.addSelection(b,b.name2FClass[d],"features")},loadTree:function(d,f,g){b.get(API_ROOT+"/osmdoc/hierarchy/"+f+"/"+g).success(function(b){d.hierarchy=b;h(d.hierarchy,{feature:function(b){d.name2FClass[b.name]=b},group:function(b){d.name2Group[b.name]=b}},[]);d.$broadcast("HierarchyLoaded")})},expandCathegories:function(b){if(!b.hierarchy)return[];var d={};g.forEach(this.cathegories.features,
function(b){d[b]=1});var f=this;h(b.hierarchy,{feature:function(b,e){g.forEach(f.cathegories.groups,function(f){0<=e.indexOf(f)&&(d[b.name]=1)})}},[]);var e=[];g.forEach(d,function(b,d){e.push(d)});return e},addSelection:function(b,d,e){e=this.cathegories[e];d&&e&&e.push(d.name);b.$broadcast("SelectCathegoryTreeNode")},removeSelection:function(b,d,e){e=this.cathegories[e];if(d&&e)for(var f=0;f<e.length;f++)if(e[f]==d.name){e.splice(f,1);break}b.$broadcast("UnselectCathegoryTreeNode")},updateSelections:function(b){h(b.hierarchy,
{group:function(b){b.selected=0<=f.cathegories.groups.indexOf(b.name)},feature:function(b,d){b.selected=0<=f.cathegories.features.indexOf(b.name)}},[])},getHierarchyCode:function(b){b="osm-"+b;return 0>f.SUPPORTED_HIERARCHIES.indexOf(b)?f.SUPPORTED_HIERARCHIES[0]:b},organizeCathegories:function(){f.cathegories.groups=filterAndSort(f.cathegories.groups);f.cathegories.features=filterAndSort(f.cathegories.features)}};return f}])})(angular,meOSMDoc);
function filterAndSort(g){return 1<g.length?a.sort().filter(function(b,g){return!g||b!=a[g-1]}):g};var meDetails=angular.module("meDetails",["meMap","meI18n"]);
meDetails.factory("details",["$http","mapService","i18nService",function(g,b,h){var e={cache:new FixedSizeFIFOCache,showPopup:function(d,e){b.isPopUPExists(d,e)?b.openPopUP(d,e):e&&(this.cache.get(e)?(b.createPopUP(d,this.cache.get(e)),b.openPopUP(d,e)):this._load(d,e,!1,function(g){b.createPopUP(d,g);b.openPopUP(d,e)}))},closePopup:function(d,e){e&&b.isPopUPExists(d,e)&&b.closePopUP(d,e)},showDetails:function(b,e){e&&(b.moreLikeThis=null,this.cache.get(e)&&this.cache.get(e)._related?(b.objectDetails=
this.cache.get(e),b.content="details",b.moreLikeThisH4=h.tr(b,"details.poi.more").format((b.formatObjectType(b.objectDetails)||"").toLowerCase())):this._load(b,e,!0,function(e){b.objectDetails=e;b.content="details";b.moreLikeThisH4=h.tr(b,"details.poi.more").format((b.formatObjectType(b.objectDetails)||"").toLowerCase())}))},_load:function(d,f,h,m){var r=API_ROOT+"/location/"+f;h&&(r+="/_related");g.get(r).success(function(g){function h(d,e){b.ready?k(d,e):window.setTimeout(function(){h(d,e)},500)}
function k(b,d){e.cache.put.apply(e.cache,[f,d]);m(d)}g&&g.feature_id&&h(d,g)})}};return e}]);FixedSizeFIFOCache=function(g){this.size=g||20;this.storage={};this.queue={};this.pointer=0};FixedSizeFIFOCache.prototype.inc=function(){this.pointer+=1;this.pointer==this.size&&(this.pointer=0)};FixedSizeFIFOCache.prototype.put=function(g,b){this.storage[g]?this.storage[g]=b:(this.storage[g]=b,delete this.storage[this.queue[this.pointer]],this.inc())};FixedSizeFIFOCache.prototype.get=function(g){return this.storage[g]};
