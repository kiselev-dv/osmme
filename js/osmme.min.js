function whTableSpan(f){var b=[],k;for(k in f)b.push(f[k][1]);for(k=0;k<b.length;k++){var e;a:{e=0;for(var d=k+1;d<b.length;d++){if(b[d].text!=b[k].text)break a;e++}}if(e){b[k].rspan=e;for(d=1;d<=e;d++)f[k+d][1]=null;k+=e}}}
function tagValueHTML(f){if(!0===f.value)return i18nService.tr($scope,"details.poi.tag.values.true");if(!1===f.value)return i18nService.tr($scope,"details.poi.tag.values.false");if("contact:website"==f.key)return'<a href="'+f.value+'">'+f.value+"</a>";if("opening_hours"==f.key){if(f.value["24_7"])return i18nService.tr($scope,"details.poi.tag.values.wh.24_7");f=getWHTable($scope,f,i18nService);whTableSpan(f);return 6==f[0][1].rspan?i18nService.tr($scope,"details.poi.tag.values.wh.evryday")+f[0][1].text:
whTableHTML(f)}return f.value}function whTableHTML(f){var b="<table>",k;for(k in f){var b=b+"<tr>",e;for(e in f[k]){var d=f[k][e];d&&(b+="<td",d.cspan&&(b+=' colspan="'+d.cspan+'"'),d.rspan&&(b+=' rowspan="'+d.rspan+'"'),b+=">",b+=d.text+"</td>")}b+="</tr>"}return b+"</table>"}
function getWHTable(f,b,k){var e=[],d="MO TU WE TH FR SA SU".split(" "),g;for(g in d){var h=[];e.push(h);var m=b.value[d[g]];h.push({text:f.dayNames[g]});m?m[2]?h.push({text:m[0]+"-"+m[m.length-1]+"<br>"+m[1]+"-"+m[2]}):h.push({text:m[0]+"-"+m[1]}):h.push({text:k.tr(f,"details.poi.tag.values.wh.off")})}return e}
function getAddress(f,b){if(!f)return[""];var k=!0;f.addresses&&f.addrTexts&&(k=f.addresses.length==f.addrTexts.length);if(f.addrTexts&&k)return f.addrTexts;f.address?(k=getAddrArray(f),"city-street-hn"==b&&k.reverse(),f.addrTexts=[k.join(", ")]):f.addresses&&(f.addrTexts=[],angular.forEach(f.addresses,function(e){e=getAddrArray(e);"city-street-hn"==b&&e.reverse();f.addrTexts.push(e.join(", "))}));return f.addrTexts}
function getAddrArray(f){var b=[];f.housenumber&&f.housenumber[0]&&b.push(f.housenumber[0]);f.street_name&&b.push(f.street_name);f.neighborhood_name?b.push(f.neighborhood_name):f.nearest_neighbour&&b.push(f.nearest_neighbour.name);f.locality_name?b.push(f.locality_name):f.nearest_place&&b.push(f.nearest_place.name);f.local_admin_name&&b.push(f.local_admin_name);f.admin2_name&&b.push(f.admin2_name);f.admin1_name&&b.push(f.admin1_name);f.admin0_name&&b.push(f.admin0_name);return b=merdgeAddrLevels(b)}
function merdgeAddrLevels(f){for(var b=[f[0]],k=1;k<f.length;k++)0>f[k-1].indexOf(f[k])&&0>f[k].indexOf(f[k-1])&&b.push(f[k]);return b};String.prototype.hashCode=function(){var f=0;if(0==this.length)return f;for(i=0;i<this.length;i++)c=this.charCodeAt(i),f=(f<<5)-f+c,f&=f;return f};String.prototype.format=function(){var f=arguments;return this.replace(/{(\d+)}/g,function(b,k){return"undefined"!=typeof f[k]?f[k]:b})};var OSMmeApp=angular.module("OSMmeApp","ngCookies ngSanitize meMap meI18n angular-google-analytics meSearch meOSMDoc meIGeocoder meDetails meRouter ngDisqus".split(" "));OSMmeApp.config(["$locationProvider",function(f){f.hashPrefix("!")}]);
ANALYTICS_CODE&&OSMmeApp.config(["AnalyticsProvider",function(f){f.setAccount(ANALYTICS_CODE)}]);OSMmeApp.directive("ngEnter",function(){return function(f,b,k){b.bind("keydown keypress",function(b){13===b.which&&(f.$apply(function(){f.$eval(k.ngEnter)}),b.preventDefault())})}});
OSMmeApp.directive("meResize",["$window",function(f){return function(b,k){var e=angular.element(f);b.getWindowDimensions=function(){var b=document.body,e=document.documentElement,h=Math.max(b.scrollHeight,b.offsetHeight,e.clientHeight,e.scrollHeight,e.offsetHeight),b=Math.max(b.scrollWidth,b.offsetWidth,e.clientWidth,e.scrollWidth,e.offsetWidth);return{h:h,w:b}};b.$watch(b.getWindowDimensions,function(d,e){b.windowHeight=d.h;b.windowWidth=d.w},!0);e.bind("resize",function(){b.$apply()})}}]);
OSMmeApp.controller("MapController",["$rootScope","$scope","$cookies","i18nService","mapService","search","docTree","details","iGeocoder","$location","routeService","Analytics",function(f,b,k,e,d,g,h,m,r,n,l,q){function v(){var d=l.getParameters(),e=[],g=[];d.pg&&d.pg.split(",").forEach(function(b){b&&e.push(b)});d.pt&&d.pt.split(",").forEach(function(b){b&&g.push(b)});e=filterAndSort(e);g=filterAndSort(g);!b.osmdocCat||angular.equals(e,b.osmdocCat.groups)&&angular.equals(g,b.osmdocCat.features)||
(b.osmdocCat.groups=e,b.osmdocCat.features=g,h.organizeCathegories(),h.updateSelections(b),b.$broadcast("SelectCathegoryTreeNode"))}b.HTML_ROOT=HTML_ROOT;f.HTML_ROOT=HTML_ROOT;ANALYTICS_CODE&&q.trackPage("/#!/"+b.lng+"/");b.mobile=800>(0<window.innerWidth?window.innerWidth:screen.width);f=n.search();l.anonymous("lang");l.parameter("id");l.parameter("map",3,!0);l.parameter("pg");l.parameter("pt");l.parameter("q");l.flag("strict");l.flag("details");l.flag("explain");if(f.fid){var t={};t.id=f.fid;f.details&&
(t.details=!0);n.search("");n.path("");l.update(t)}var p=l.getParameters();p.lang||l.update("lang",initLang(k));b.lng=p.lang||initLang(k);b.hierarchyCode=h.getHierarchyCode(b.lng);b.langsAvaible=["en","ru"];b.name2FClass={};b.name2Group={};h.loadTree(b,b.lng,b.hierarchyCode);e.getTranslation(b,b.lng,!0,function(){var f=[null,null,null];p.map&&(f=p.map);f=d.createMap(b,f[1],f[2],f[0]);r.create(b,f);h.attach(b);g.attach(b);b.dayNames=e.tr(b,"details.poi.tag.values.wh.days").split(" ")});b.activeFeatureID=
p.fid;b.explain=p.explain;b.content=p.details?"details":"map";b.activeFeatureID&&("details"==b.content?m.showDetails(b,b.activeFeatureID):m.showPopup(b,b.activeFeatureID));b.$on("$locationChangeSuccess",function(){var e=b.activeFeatureID,g=l.getParameters();b.lng!=g.lang&&(k.lang=g.lang,l.reload());b.activeFeatureID=g.id;b.explain=g.explain;b.content=g.details?"details":"map";"details"==b.content?(ANALYTICS_CODE&&q.trackPage("/#!/"+b.lng+"/id/"+b.activeFeatureID+"/details"),m.showDetails(b,b.activeFeatureID),
e&&m.closePopup(b,e)):(b.activeFeatureID?(ANALYTICS_CODE&&q.trackPage("/#!/"+b.lng+"/id/"+b.activeFeatureID),m.showPopup(b,b.activeFeatureID)):void 0!==e&&e!=b.activeFeatureID&&m.closePopup(b,e),l.getParameters().map&&(e=l.getParameters().map,d.broadcastAction||d.setView(e[1],e[2],e[0])));g.strict&&(b.strictSearch=!0);g.q&&null==b.searchQuerry&&b.searchQuerry!=g.q&&(b.searchQuerry=g.q,b.$broadcast("Search",g.q));v()});b.$on("Search",function(){l.update("q",b.searchQuerry)});b.$on("SelectFeature",
function(){l.update("q",b.searchQuerry)});b.$on("HierarchyLoaded",v);b.$on("PopupClose",function(d,e){"map"==b.content&&l.update("id",null)});b.$on("PopupOpen",function(b,d){l.update({id:d,map:null})});b.$on("MapViewChanged",function(){l.update("map",d.getStateArray())});n=function(){b.osmdocCat&&(h.organizeCathegories(),0<b.osmdocCat.features.length?l.update("pt",b.osmdocCat.features.join()):l.update("pt",null),0<b.osmdocCat.groups.length?l.update("pg",b.osmdocCat.groups.join()):l.update("pg",null),
d.filterMarkersByTypes(b,h.expandCathegories(b)),h.updateSelections(b))};b.$on("CloseSearchResults",function(){b.searchQuerry="";b.searchResultsPage=null;b.srPages=null;d.filterMarkersByTypes(b,h.expandCathegories(b));h.updateSelections(b)});b.$on("SelectCathegoryTreeNode",n);b.$on("UnselectCathegoryTreeNode",n);b.formatObjectType=function(d){return d&&d.poi_class&&(d=b.translateTypeNames(d),0<d.length)?d.join(", "):null};b.translateTypeNames=function(d){var e=[];if(d&&d.poi_class)for(var g in d.poi_class){var h=
d.poi_class[g];b.name2FClass&&b.name2FClass[h]&&(h=b.name2FClass[h].translated_title,h.toUpperCase()!==(d.name||"").toUpperCase()&&e.push(h))}return e};b.nameContainsType=function(d){if(d){var e=b.translateTypeNames(d);d=(d.name||"").toLowerCase();for(var g in e)if(0<=d.indexOf(e[g].toLowerCase()))return!0}return!1};b.tagValueHTML=tagValueHTML;b.buildingType=function(d){return e.tr(b,"details.adr.building")};b.mergeIntoPath=function(b,d){return"/#!"+l.mergeIntoPath(b,d)};b.searchKeyDown=function(d){38==
d.keyCode?(d.stopPropagation(),d.preventDefault(),b.$broadcast("SearchKeyUp")):40==d.keyCode&&b.$broadcast("SearchKeyDown")};b.$watch("searchQuerry",function(d,e){""!=e&&""==d&&b.$broadcast("CleanSearchInput")});b.$on("CleanSearchInput",function(){l.update("q",null)});b.formatSearchResultTitle=function(d){if(!d)return"";if("adrpnt"==d.type)return e.tr(b,"map.js.search.title.adrpnt");if(d.name||d.poi_class){var g=b.formatObjectType(d),h=d.name||g;d.name&&g&&(h+=" ("+g+")");return h}return""};b.formatSearchResultAddress=
function(d){return d?getAddress(d,b.translation?b.translation["addr.order"]:"hn-street-city")[0]:""};b.getAddress=function(d){return getAddress(d,b.translation?b.translation["addr.order"]:"hn-street-city")};b.selectRow=function(d){b.$broadcast("SelectFeature",d)};b.searchInputEnter=function(){b.suggestedFeature?b.suggestedFeature.feature_id?b.$broadcast("SelectFeature",b.suggestedFeature):b.selectPoiType(b.suggestedFeature.name):b.$broadcast("Search",b.searchQuerry)};b.removeSelected=function(d,e){h.removeSelection(b,
{name:d},e)}}]);function initLang(f){return f.lang?f.lang:"ru"}disqus_shortname="osmme";var router=angular.module("meRouter",[]);
router.factory("routeService",["$location",function(f){function b(){this.parameters=[];this.byName={}}b.prototype.parameter=function(b,e,d,g){e={name:b,type:"parameter",escape:g||!0,slashes:e||0,skipSave:d||!1};this.byName[b]||(this.parameters.push(e),this.byName[b]=e)};b.prototype.anonymous=function(b,e,d,g){e={name:b,type:"anonymous",escape:g||!0,skipSave:d||!1};this.byName[b]||(this.parameters.push(e),this.byName[b]=e)};b.prototype.flag=function(b,e){var d={name:b,type:"flag",skipSave:e||!1};this.byName[b]||
(this.parameters.push(d),this.byName[b]=d)};b.prototype.template=function(){var b="/";angular.forEach(this.parameters,function(e){"anonymous"==e.type&&(b+=":"+e.name+"/");"flag"==e.type&&(b+="?"+e.name+"/");if("parameter"==e.type&&(b+=e.name+"/:"+e.name+"/",e.slashes))for(var d=0;d<e.slashes-1;d++)b+=":"+e.name+"/"});return b};b.prototype.getParameters=function(){var b=[];angular.forEach(f.path().split("/"),function(d){d&&b.push(d)});for(var e=0,d={},g=0;g<b.length;g++)for(var h=e;h<this.parameters.length;h++){var m=
this.parameters[h],r=b[g];if("anonymous"==m.type){d[m.name]=r;e++;break}else if("flag"==m.type&&m.name==r){d[m.name]=!0;e++;break}else if("parameter"==m.type&&m.name==r){if(m.slashes)for(h=g+1;h<Math.min(b.length,g+1+m.slashes);h++)d[m.name]||(d[m.name]=[]),d[m.name].push(b[h]);else d[m.name]=b[g+1];g+=m.slashes||1;e++;break}}return d};b.prototype.createPath=function(b){for(var e="/",d=0;d<this.parameters.length;d++){var g=this.parameters[d];"anonymous"==g.type&&b[g.name]&&(e+=b[g.name]+"/");"flag"==
g.type&&b[g.name]&&(e+=g.name+"/");if("parameter"==g.type&&b[g.name])if(e+=g.name+"/",g.slashes)for(var h=0;h<g.slashes;h++)e+=b[g.name][h]+"/";else e+=b[g.name]+"/"}return e};b.prototype.update=function(b,e,d){var g={};void 0===e&&void 0===d?g=b:g[b]=e;e=angular.extend(this.getParameters(),g);e=this.createPath(e);e=f.path(e);this.byName[b]&&this.byName[b].skipSave&&!d&&e.replace();return e};b.prototype.mergeIntoPath=function(b,e){var d={};void 0===e?d=b:d[b]=e;d=angular.extend(this.getParameters(),
d);return this.createPath(d)};b.prototype.reload=function(){window.location.reload()};return new b}]);var MapModule=angular.module("meMap",["ngCookies","meI18n"]);
(function(f,b){function k(b,d){var g=Math.pow(10,d);return Math.round(b*g)/g}b.factory("mapService",["i18nService","$rootScope","$cookies","$compile","$http",function(b,d,g,h,f){var r=L.Control.extend({container:null,options:{position:"topleft"},setScope:function(b){this.scope=b;return this},setContainer:function(b){var d=L.DomUtil.create("div","search-control");L.DomEvent.disableClickPropagation(d);L.DomEvent.addListener(d,"mousewheel",function(b){var d=document.getElementById("r-scroll-pane");d&&
(d.scrollTop-=20*L.DomEvent.getWheelDelta(b));L.DomEvent.stopPropagation(b)});d.innerHTML=b;this.container=d},onAdd:function(b){return this.container}}),n={id2Feature:{},id2Marker:{},ready:!1,createMap:function(l,q,k,t){q=q||g.lat||DEFAULT_LAT;if(90<q||-90>q)q=DEFAULT_LAT;k=k||g.lon||DEFAULT_LON;if(180<k||-180>k)k=DEFAULT_LON;t=t||g.z||DEFAULT_ZOOM;0>=t&&(t=DEFAULT_ZOOM);this.map=L.map("map",{zoomControl:!1}).setView([q,k],t);q=b.tr(l,"map.js.copy.data")+' &copy; <a href="http://osm.org">'+b.tr(l,
"map.js.copy.contributors")+"</a>, "+b.tr(l,"map.js.copy.rendering")+' <a href="http://giscience.uni-hd.de/" target="_blank">University of Heidelberg</a>';q=L.tileLayer("http://openmapsurfer.uni-hd.de/tiles/roads/x={x}&y={y}&z={z}",{attribution:q,maxZoom:18}).addTo(this.map);k=b.tr(l,"map.js.copy.contributors")+'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a>';t=L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:k});k={};k[b.tr(l,"map.js.layer.relief")]=L.tileLayer("http://openmapsurfer.uni-hd.de/tiles/asterh/x={x}&y={y}&z={z}",
{maxZoom:18});k[b.tr(l,"map.js.layer.contours")]=L.tileLayer("http://openmapsurfer.uni-hd.de/tiles/asterc/x={x}&y={y}&z={z}",{maxZoom:18});q={Mapnik:t,MapSurfer:q};l.mobile||(this.layersControl=L.control.layers(q,k),this.layersControl.addTo(this.map));var p=this.map;this.map.on("viewreset",function(){window.setTimeout(function(){n.saveStateToCookie.apply(n,[]);n.broadcastAction=!0;l.$broadcast("MapViewChanged",p.getCenter(),p.getZoom());d.$$phase||d.$apply();n.broadcastAction=!1},10)});this.map.on("moveend",
function(){window.setTimeout(function(){n.saveStateToCookie.apply(n,[]);n.broadcastAction=!0;l.$broadcast("MapViewChanged",p.getCenter(),p.getZoom());d.$$phase||d.$apply();n.broadcastAction=!1},10)});this.map.on("popupopen",function(b){var e=p.project(b.popup._latlng);e.y-=b.popup._container.clientHeight/2;p.panTo(p.unproject(e),{animate:!1});l.$broadcast("PopupOpen",b.popup._source?b.popup._source.feature_id:b.popup.feature_id);d.$$phase||d.$apply()});this.map.on("popupclose",function(b){l.$broadcast("PopupClose",
b.popup._source?b.popup._source.feature_id:b.popup.feature_id);d.$$phase||d.$apply()});this.ready=!0;var u=this.searchControl=(new r).setScope(l);f.get(HTML_ROOT+"/templates/search_control.html").success(function(b){u.setContainer(b);u.addTo(p);h(u.container)(l)});return this.map},createPopUP:function(b,d){if(!this.id2Feature[d.feature_id]){this.id2Feature[d.feature_id]=d;var e=d.poi_class?b.name2FClass[d.poi_class[0]]:null,g=this;this.loadIcon(e,function(){var h=L.marker([d.center_point.lat,d.center_point.lon]);
e&&e.ll_icon&&(h=L.marker([d.center_point.lat,d.center_point.lon],{icon:e.ll_icon}));g.id2Marker[d.feature_id]=h;h.addTo(g.map).bindPopup(g.getPopUPHtml(d,d.feature_id,b));h.feature_id=d.feature_id})}},openPopUP:function(b,d,e){if(d&&this.id2Marker[d])if(angular.element(this.map.getContainer()).hasClass("ng-hide")){var g=this,h=e||5;0<h&&window.setTimeout(function(){g.openPopUP.apply(g,[b,d,h])},100)}else this.id2Marker[d]._popup._isOpen||(this.map.invalidateSize(!1),this.id2Marker[d].openPopup())},
closePopUP:function(b,d){d&&this.id2Marker[d]&&this.id2Marker[d].closePopup()},isPopUPExists:function(b,d){return d&&!!this.id2Marker[d]},getPopUPHtml:function(d,g,h){var f=h.formatSearchResultTitle(d);d=getAddress(d,h.translation?h.translation["addr.order"]:"hn-street-city")[0];g='<a class="more-link" href="'+h.mergeIntoPath({details:!0,id:g})+'">'+b.tr(h,"map.js.popup.more")+"</a>";return f?'<div class="fpopup"><h2>'+f+"</h2><div>"+d+"</div><div>"+g+"</div>":"<div>"+d+"</div>"+g},remove:function(b,
d){void 0!==this.id2Feature[d]&&(this.id2Marker[d]&&(this.map.removeLayer(this.id2Marker[d]),delete this.id2Marker[d]),delete this.id2Feature[d],b.activeFeatureID=null)},clearAllMarkers:function(b){this.filterMarkersByTypes(b,[])},filterMarkersByTypes:function(b,d){var e=[];angular.forEach(this.id2Feature,function(b,g){0>d.indexOf(b.class_name)&&e.push(g)});angular.forEach(e,function(d){n.remove.apply(n,[b,d])})},getStateString:function(){var b=this.map.getCenter(),d=this.map.getZoom();return 0<d&&
90>b.lat&&-90<b.lat&&-180<b.lng&&180>b.lng?d+"/"+k(b.lat,5)+"/"+k(b.lng,5):null},getStateArray:function(){var b=this.map.getCenter(),d=this.map.getZoom();return 0<d&&90>b.lat&&-90<b.lat&&-180<b.lng&&180>b.lng?[d,k(b.lat,5),k(b.lng,5)]:null},saveStateToCookie:function(){var b=this.map.getCenter(),d=this.map.getZoom();0<d&&90>b.lat&&-90<b.lat&&-180<b.lng&&180>b.lng&&(g.lat=b.lat,g.lon=b.lng,g.z=d)},setView:function(b,d,e){0<e&&90>b&&-90<b&&-180<d&&180>d&&this.map&&this.map.setView([b,d],e)},imgWaiters:{},
loadIcon:function(b,d){if(b)if(void 0===b.ll_icon){var e=TYPE_ICONS_ROOT+"/"+b.icon;if(void 0===this.imgWaiters[e]){thisClosure=this;this.imgWaiters[e]=[];this.imgWaiters[e].push(d);var g=new Image;g.onload=function(){b.ll_icon=L.icon({iconUrl:e,iconSize:[32,37],iconAnchor:[16,37],popupAnchor:[0,-38]});for(var d=0;d<thisClosure.imgWaiters[e].length;d++)thisClosure.imgWaiters[e][d]();thisClosure.imgWaiters[e]=null};g.onerror=function(){b.ll_icon=null;for(var d=0;d<thisClosure.imgWaiters[e].length;d++)thisClosure.imgWaiters[e][d]();
thisClosure.imgWaiters[e]=null};g.src=e}else null===this.imgWaiters[e]?d():this.imgWaiters[e].push(d)}else d();else d()}};return n}])})(angular,MapModule);var meI18n=angular.module("meI18n",["ngResource"]);
meI18n.factory("i18nService",["$resource",function(f){return{getTranslation:function(b,k,e,d){var g=HTML_ROOT+"/i18n/map_"+k+".json",h="map.js_"+k;sessionStorage&&!e?sessionStorage.getItem(h)?(b.translation=JSON.parse(sessionStorage.getItem(h)),d&&d()):f(g).get(function(e){b.translation=e;sessionStorage.setItem(h,JSON.stringify(b.translation));d()}):f(g).get(function(e){b.translation=e;d()})},tr:function(b,f){return void 0!==b.translation&&void 0!==b.translation[f]?b.translation[f]:f}}}]);var meIGeocoder=angular.module("meIGeocoder",["ngResource","meMap","meDetails"]);
(function(f,b){b.factory("iGeocoder",["$http","mapService","details",function(b,e,d){return{create:function(b,d){var f=this;d.on("click",function(b){14<d.getZoom()&&f.sendRequest(b.latlng.lng,b.latlng.lat)});this.scope=b;b.$on("CloseInverseGeocodeResults",function(){b.inverseGeocodeResults=null;e.filterMarkersByTypes(b,[])})},sendRequest:function(d,e){var f=this;b.get(API_ROOT+"/location/latlon/"+e+"/"+d+"/_related").success(function(b){f.showAnswer.apply(f,[b])})},showAnswer:function(b){if(b&&b.feature_id){this.scope.$broadcast("CloseSearchResults",
b.feature_id);this.scope.inverseGeocodeResults=b;var d=this.scope;e.createPopUP(d,b);b._related&&b._related._same_building&&angular.forEach(b._related._same_building,function(b){e.createPopUP(d,b)});b._eclosed&&angular.forEach(b._eclosed,function(b){e.createPopUP(d,b)});b._neighbours&&angular.forEach(b._neighbours,function(b){e.createPopUP(d,b)})}}}}])})(angular,meIGeocoder);var meSearch=angular.module("meSearch",["meMap","meOSMDoc"]);
meSearch.factory("search",["$http","mapService","docTree",function(f,b,k){var e={resetMap:!1,selectedSuggestion:-1,queryHead:null,userSearchInput:"",restrictWithBBOX:!1,suggestTimer:null,attach:function(d){d.$on("MapViewChanged",function(b){e.pagesMode||e.listPOI.apply(e,[d,1])});d.$on("SelectCathegoryTreeNode",function(){d.searchQuerry="";d.searchResultsPage={};e.pagesMode=!1;e.listPOI.apply(e,[d,1])});d.$on("UnselectCathegoryTreeNode",function(){e.pagesMode=!1;e.listPOI.apply(e,[d,1])});d.$on("Search",
function(){e.pagesCenter=b.map.getCenter();e.search.apply(e,[d,1])});d.$on("SearchKeyUp",function(){e.moveUp.apply(e,[d])});d.$on("SearchKeyDown",function(){e.moveDown.apply(e,[d])});d.$on("SelectFeature",function(e,h){b.openPopUP(d,h.feature_id)});d.$watch("searchQuerry",function(b,h){e.suppressOnSearchQuerry?e.suppressOnSearchQuerry=!1:(e.suggestTimer&&window.clearTimeout(e.suggestTimer),e.suggestTimer=window.setTimeout(function(){e.suggest(d)},300))});d.searchResultsPage={};d.getSRPages=function(){e.listPages(d)};
d.goPage=function(b){e.search(d,b.p)}},search:function(b,g){e.restrictWithBBOX=!1;e.userSearchInput="";if(b.searchQuerry){var h={q:b.searchQuerry,mark:e.getHash(b),page:g,hierarchy:b.hierarchyCode,explain:b.explain};b.osmdocCat&&(b.osmdocCat.features||b.osmdocCat.groups)&&(h.poiclass=b.osmdocCat.features,h.poigroup=b.osmdocCat.groups);b.strictSearch&&(h.strict=!0);e.pagesCenter&&(h.lat=e.pagesCenter.lat,h.lon=e.pagesCenter.lng);f.get(API_ROOT+"/location/_search",{params:h}).success(function(g){e.searchSuccess.apply(e,
[b,g])})}},searchSuccess:function(d,g){if("success"==g.result){var h=this.getHash(d);if(g.mark==h){b.closePopUP(d,d.activeFeatureID);d.searchResultsPage&&d.searchResultsPage.features&&angular.forEach(d.searchResultsPage.features,function(e){b.remove(d,e.feature_id)});d.searchResultsPage=g;d.getSRPages();var f=[];angular.forEach(g.features,function(e,g){b.createPopUP(d,e,e.feature_id);f.push(e.center_point)});e.resetMap&&f&&0<f.length&&b.map.fitBounds(L.latLngBounds(f))}}},suggest:function(b){if(b.searchQuerry&&
!(3>b.searchQuerry.length)&&(e.selectedSuggestion=-1,b.selectedSuggestion=-1,!e.waitForAnswer)){e.waitForAnswer=!0;var g={q:b.searchQuerry,size:10,mark:this.getHash(b),hierarchy:b.hierarchyCode};b.strictSearch&&(g.strict=!0);f.get(API_ROOT+"/location/_suggest",{params:g}).success(function(g){e.waitForAnswer=!1;e.searchSuccess.apply(e,[b,g])})}},listPOI:function(d,g){if(0!=k.cathegories.features.length||0!=k.cathegories.groups)e.restrictWithBBOX=!0,f.get(API_ROOT+"/location/_search",{params:{q:d.searchQuerry,
poiclass:k.cathegories.features,poigroup:k.cathegories.groups,bbox:b.map.getBounds().toBBoxString(),size:20,page:g,mark:e.getHash(d),hierarchy:d.hierarchyCode}}).success(function(b){"success"==b.result&&e.listPOISuccess.apply(e,[b,d])})},listPOISuccess:function(d,g){var h=e.getHash(g);d.mark==h&&(angular.forEach(d.features,function(d,e){b.createPopUP(g,d)}),d.page*d.size<d.hits&&10>d.page&&e.listPOI(g,d.page+1))},getHash:function(b){return(""+{poiclass:b.osmdocCat.features,poigroup:b.osmdocCat.groups,
query:b.searchQuerry}).hashCode()},listPages:function(b){var e={};if(b.searchResultsPage){var h=b.searchResultsPage.hits,f=b.searchResultsPage.page,k=b.searchResultsPage.size,n=parseInt(h/k);0==h%k&&(n+=1);for(h=1;h<=n&&8>=h;h++)e[h]={p:h,active:f==h};for(h=f-1;h<=f+1;h++)0<h&&h<=n&&(e[h]={p:h,active:f==h});for(h=n-2;h<=n;h++)0<h&&(e[h]={p:h,active:f==h})}var l=[];angular.forEach(e,function(b){l.push(b)});l.sort(function(b,d){return b.p-d.p});b.srPages=l},moveUp:function(b){e.selectedSuggestion--;
 -1>=e.selectedSuggestion&&(e.selectedSuggestion=-1);if(-1==e.selectedSuggestion)b.searchQuerry=e.userSearchInput,b.selectedSuggestion=null,b.suggestedFeature=null;else{var g=b.searchResultsPage.matched_type.slice(0),g=g.concat(b.searchResultsPage.features);b.searchQuerry.split(/[\s,;.]+/);var g=g[e.selectedSuggestion],h=e.getToken(g),f=" "===e.queryHead.slice(-1)?"":" ",h=e.queryHead+f+h,h=" "===h.slice(-1)?h:h+" ";e.suppressOnSearchQuerry=!0;b.searchQuerry=h;b.selectedSuggestion=e.getId(g);b.suggestedFeature=
g}},moveDown:function(b){var g=b.searchQuerry.split(/[\s,;.]+/);-1==e.selectedSuggestion&&(e.userSearchInput=b.searchQuerry,g.pop(),e.queryHead=g.join(" "));g=b.searchResultsPage.matched_type.slice(0);g=g.concat(b.searchResultsPage.features);e.selectedSuggestion++;e.selectedSuggestion>=g.length&&(e.selectedSuggestion=g.length-1);var g=g[e.selectedSuggestion],h=e.getToken(g),f=" "===e.queryHead.slice(-1)?"":" ",h=e.queryHead+f+h,h=" "===h.slice(-1)?h:h+" ";e.suppressOnSearchQuerry=!0;b.searchQuerry=
h;b.selectedSuggestion=e.getId(g);b.suggestedFeature=g},getToken:function(b){return b.type?b.name||b.housenumber:b.translated_title[0]},getId:function(b){return b.feature_id||b.name}};return e}]);var meOSMDoc=angular.module("meOSMDoc",["meMap"]);
(function(f,b){function k(b,d,g){angular.forEach(b.features,function(b){d.feature&&d.feature(b,g)});angular.forEach(b.groups,function(b){g.push(b.name);d.group&&d.group(b);k(b,d,g);g.pop(b.name)})}b.factory("docTree",["$http","mapService",function(b,d){var g={SUPPORTED_HIERARCHIES:["osm-ru"],cathegories:{features:[],groups:[]},attach:function(b){b.osmdocCat=g.cathegories;b.expand=function(b){b.expanded=!b.expanded};b.selectPoiType=function(d){g.selectPoiType.apply(g,[b,d])};b.selectCathegory=function(e,
f){e.selected?g.addSelection.apply(g,[b,e,f]):g.removeSelection.apply(g,[b,e,f]);var k=g.expandCathegories.apply(g,[b]);d.filterMarkersByTypes.apply(d,[b,k])};b.listMoreTags=function(d){if(!d||!b.name2FClass)return null;if(d.__translatedTags&&0<d.__translatedTags.length)return d.__translatedTags;var e=d.poi_class,g=[];angular.forEach(d.more_tags,function(d,f){for(var k in e){var m={},p=b.name2FClass[e[k]];p&&(p=p.more_tags[f])&&(m.name=p.name,m.type=p.valueType,m.key=f,p.values[d]?(m.value=p.values[d].name,
m.group=p.values[d].group):m.value=d,g.push(m))}});return d.__translatedTags=g}},selectPoiType:function(b,d){this.addSelection(b,b.name2FClass[d],"features")},loadTree:function(d,g,f){b.get(API_ROOT+"/osmdoc/hierarchy/"+g+"/"+f).success(function(b){d.hierarchy=b;k(d.hierarchy,{feature:function(b){d.name2FClass[b.name]=b},group:function(b){d.name2Group[b.name]=b}},[]);d.$broadcast("HierarchyLoaded")})},expandCathegories:function(b){if(!b.hierarchy)return[];var d={};f.forEach(this.cathegories.features,
function(b){d[b]=1});var e=this;k(b.hierarchy,{feature:function(b,g){f.forEach(e.cathegories.groups,function(e){0<=g.indexOf(e)&&(d[b.name]=1)})}},[]);var g=[];f.forEach(d,function(b,d){g.push(d)});return g},addSelection:function(b,d,e){e=this.cathegories[e];d&&e&&e.push(d.name);b.$broadcast("SelectCathegoryTreeNode")},removeSelection:function(b,d,e){e=this.cathegories[e];if(d&&e)for(var g=0;g<e.length;g++)if(e[g]==d.name){e.splice(g,1);break}b.$broadcast("UnselectCathegoryTreeNode")},updateSelections:function(b){k(b.hierarchy,
{group:function(b){b.selected=0<=g.cathegories.groups.indexOf(b.name)},feature:function(b,d){b.selected=0<=g.cathegories.features.indexOf(b.name)}},[])},getHierarchyCode:function(b){b="osm-"+b;return 0>g.SUPPORTED_HIERARCHIES.indexOf(b)?g.SUPPORTED_HIERARCHIES[0]:b},organizeCathegories:function(){g.cathegories.groups=filterAndSort(g.cathegories.groups);g.cathegories.features=filterAndSort(g.cathegories.features)}};return g}])})(angular,meOSMDoc);
function filterAndSort(f){return 1<f.length?a.sort().filter(function(b,f){return!f||b!=a[f-1]}):f};var meDetails=angular.module("meDetails",["meMap","meI18n"]);
meDetails.factory("details",["$http","mapService","i18nService",function(f,b,k){var e={cache:new FixedSizeFIFOCache,showPopup:function(d,e){b.isPopUPExists(d,e)?b.openPopUP(d,e):e&&(this.cache.get(e)?(b.createPopUP(d,this.cache.get(e)),b.openPopUP(d,e)):this._load(d,e,!1,function(f){b.createPopUP(d,f);b.openPopUP(d,e)}))},closePopup:function(d,e){e&&b.isPopUPExists(d,e)&&b.closePopUP(d,e)},showDetails:function(b,e){e&&(b.moreLikeThis=null,this.cache.get(e)&&this.cache.get(e)._related?(b.objectDetails=
this.cache.get(e),b.content="details",b.moreLikeThisH4=k.tr(b,"details.poi.more").format((b.formatObjectType(b.objectDetails)||"").toLowerCase())):this._load(b,e,!0,function(e){b.objectDetails=e;b.content="details";b.moreLikeThisH4=k.tr(b,"details.poi.more").format((b.formatObjectType(b.objectDetails)||"").toLowerCase())}))},_load:function(d,g,h,k){var r=API_ROOT+"/location/"+g;h&&(r+="/_related");f.get(r).success(function(f){function h(d,e){b.ready?q(d,e):window.setTimeout(function(){h(d,e)},500)}
function q(b,d){e.cache.put.apply(e.cache,[g,d]);k(d)}f&&f.feature_id&&h(d,f)})}};return e}]);FixedSizeFIFOCache=function(f){this.size=f||20;this.storage={};this.queue={};this.pointer=0};FixedSizeFIFOCache.prototype.inc=function(){this.pointer+=1;this.pointer==this.size&&(this.pointer=0)};FixedSizeFIFOCache.prototype.put=function(f,b){this.storage[f]?this.storage[f]=b:(this.storage[f]=b,delete this.storage[this.queue[this.pointer]],this.inc())};FixedSizeFIFOCache.prototype.get=function(f){return this.storage[f]};
