function whTableSpan(e){var a=[],h;for(h in e)a.push(e[h][1]);for(h=0;h<a.length;h++){var d;a:{d=0;for(var b=h+1;b<a.length;b++){if(a[b].text!=a[h].text)break a;d++}}if(d){a[h].rspan=d;for(b=1;b<=d;b++)e[h+b][1]=null;h+=d}}}
function getWHTable(e,a,h){var d=[],b="MO TU WE TH FR SA SU".split(" "),g;for(g in b){var f=[];d.push(f);var l=a.value[b[g]];f.push({text:e.dayNames[g]});l?l[2]?f.push({text:l[0]+"-"+l[l.length-1]+"<br>"+l[1]+"-"+l[2]}):f.push({text:l[0]+"-"+l[1]}):f.push({text:h.tr(e,"details.poi.tag.values.wh.off")})}return d}
function tagValueHTML(e,a,h){if(!0===e.value)return h.tr(a,"details.poi.tag.values.true");if(!1===e.value)return h.tr(a,"details.poi.tag.values.false");if("contact:website"==e.key)return'<a href="'+e.value+'">'+e.value+"</a>";if("opening_hours"==e.key){if(e.value["24_7"])return h.tr(a,"details.poi.tag.values.wh.24_7");e=getWHTable(a,e,h);whTableSpan(e);return 6==e[0][1].rspan?h.tr(a,"details.poi.tag.values.wh.evryday")+e[0][1].text:whTableHTML(e)}return e.value}
function whTableHTML(e){var a="<table>",h;for(h in e){var a=a+"<tr>",d;for(d in e[h]){var b=e[h][d];b&&(a+="<td",b.cspan&&(a+=' colspan="'+b.cspan+'"'),b.rspan&&(a+=' rowspan="'+b.rspan+'"'),a+=">",a+=b.text+"</td>")}a+="</tr>"}return a+"</table>"}
function getAddress(e,a){if(!e)return[""];var h=!0;e.addresses&&e.addrTexts&&(h=e.addresses.length==e.addrTexts.length);if(e.addrTexts&&h)return e.addrTexts;e.address?(h=getAddrArray(e),"city-street-hn"==a&&h.reverse(),e.addrTexts=[h.join(", ")]):e.addresses&&(e.addrTexts=[],angular.forEach(e.addresses,function(d){d=getAddrArray(d);"city-street-hn"==a&&d.reverse();e.addrTexts.push(d.join(", "))}));return e.addrTexts}
function getAddrArray(e){var a=[];e.housenumber&&e.housenumber[0]&&a.push(e.housenumber[0]);e.street_name&&a.push(e.street_name);e.neighborhood_name?a.push(e.neighborhood_name):e.nearest_neighbour&&a.push(e.nearest_neighbour.name);e.locality_name?a.push(e.locality_name):e.nearest_place&&a.push(e.nearest_place.name);e.local_admin_name&&ADDR_LOCAL_ADMIN&&a.push(e.local_admin_name);e.admin2_name&&ADDR_ADMIN2&&a.push(e.admin2_name);e.admin1_name&&ADDR_ADMIN1&&a.push(e.admin1_name);e.admin0_name&&ADDR_ADMIN0&&
a.push(e.admin0_name);return a=merdgeAddrLevels(a)}function merdgeAddrLevels(e){for(var a=[e[0]],h=1;h<e.length;h++)0>e[h-1].indexOf(e[h])&&0>e[h].indexOf(e[h-1])&&a.push(e[h]);return a}
function isMobile(){var e=navigator.userAgent||navigator.vendor||window.opera;return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,
4))};String.prototype.hashCode=function(){var e=0;if(0==this.length)return e;for(i=0;i<this.length;i++)c=this.charCodeAt(i),e=(e<<5)-e+c,e&=e;return e};String.prototype.format=function(){var e=arguments;return this.replace(/{(\d+)}/g,function(a,h){return"undefined"!=typeof e[h]?e[h]:a})};function filterAndSort(e){return 1<e.length?e.sort().filter(function(a,h){return!h||a!=e[h-1]}):e}var OSMmeApp=angular.module("OSMmeApp","ngCookies ngSanitize meMap meI18n angular-google-analytics meSearch meOSMDoc meIGeocoder meDetails meRouter ngDisqus".split(" "));
OSMmeApp.config(["$locationProvider",function(e){e.hashPrefix("!")}]);ANALYTICS_CODE&&OSMmeApp.config(["AnalyticsProvider",function(e){e.setAccount(ANALYTICS_CODE)}]);OSMmeApp.directive("dynamic",function(e){return{restrict:"A",replace:!0,link:function(a,h,d){a.$watch(d.dynamic,function(b){h.html(b);e(h.contents())(a)})}}});OSMmeApp.directive("ngEnter",function(){return function(e,a,h){a.bind("keydown keypress",function(a){13===a.which&&(e.$apply(function(){e.$eval(h.ngEnter)}),a.preventDefault())})}});
OSMmeApp.directive("meResize",["$window",function(e){return function(a,h){var d=angular.element(e);a.getWindowDimensions=function(){var a=document.body,d=document.documentElement,f=Math.max(a.scrollHeight,a.offsetHeight,d.clientHeight,d.scrollHeight,d.offsetHeight),a=Math.max(a.scrollWidth,a.offsetWidth,d.clientWidth,d.scrollWidth,d.offsetWidth);return{h:f,w:a}};a.$watch(a.getWindowDimensions,function(b,d){a.windowHeight=b.h;a.windowWidth=b.w},!0);d.bind("resize",function(){a.$$phase||a.$apply()})}}]);
OSMmeApp.controller("MapController",["$rootScope","$scope","$cookies","i18nService","mapService","search","docTree","details","iGeocoder","$location","routeService","Analytics",function(e,a,h,d,b,g,f,l,t,m,k,p){function v(){var b=k.getParameters(),d=[],g=[];b.pg&&b.pg.split(",").forEach(function(a){a&&d.push(a)});b.pt&&b.pt.split(",").forEach(function(a){a&&g.push(a)});d=filterAndSort(d);g=filterAndSort(g);!a.osmdocCat||angular.equals(d,a.osmdocCat.groups)&&angular.equals(g,a.osmdocCat.features)||
(a.osmdocCat.groups=d,a.osmdocCat.features=g,f.organizeCathegories(),f.updateSelections(a),f.loadTagValuesStatistic(a),a.$broadcast("SelectCathegoryTreeNode"))}a.SITE_SESSION=Math.floor(65536*(1+Math.random())).toString(16).substring(1);a.HTML_ROOT=HTML_ROOT;e.HTML_ROOT=HTML_ROOT;e.pathWithRoot=function(a){return HTML_ROOT+a};a.pathWithRoot=function(a){return HTML_ROOT+a};e=m.search();k.flag("m");k.anonymous("lang");k.parameter("id");k.parameter("map",3,!0);k.parameter("pg");k.parameter("pt");k.parameter("q");
k.flag("strict");k.flag("details");k.flag("explain");if(e.fid){var r={};r.id=e.fid;e.details&&(r.details=!0);m.search("");m.path("");k.update(r)}a.searchForm={};a.langsAvaible=["en","ru"];var n=k.getParameters();0>a.langsAvaible.indexOf(n.lang)&&(m=initLang(h),0<=a.langsAvaible.indexOf(n.lang)?k.update("lang",m):k.update("lang",DEFAULT_LANGUAGE));a.mobile=isMobile();n.m!=a.mobile&&k.update("m",a.mobile);ANALYTICS_CODE&&p.trackPage("/#!/"+a.lng+"/");angular.element(document.getElementsByTagName("head")[0]).append('<link rel="stylesheet" type="text/css" href="css/'+
(a.mobile?"mobile":"descktop")+'.css" />');a.lng=n.lang||initLang(h);a.hierarchyCode=f.getHierarchyCode(a.lng);a.name2FClass={};a.name2Group={};f.loadTree(a,a.lng,a.hierarchyCode);d.getTranslation(a,a.lng,!0,function(){var k=[null,null,null];n.map&&(k=n.map);var l=b.createMap(a,k[1],k[2],k[0]);t.create(a,l);f.attach(a);g.attach(a);a.dayNames=d.tr(a,"details.poi.tag.values.wh.days").split(" ");b.enquirePosition(function(b){if(b){var d=b.coords.latitude,f=b.coords.longitude;500<l.getCenter().distanceTo([d,
f])&&t.sendRequest(f,d,!1,function(b){b&&b.text?(b.lat=d,b.lon=f,a.browserGeoLocation=b):a.browserGeoLocation&&delete a.browserGeoLocation})}})});a.activeFeatureID=n.fid;a.explain=n.explain;a.content=n.details?"details":"map";a.activeFeatureID&&("details"==a.content?l.showDetails(a,a.activeFeatureID):l.showPopup(a,a.activeFeatureID));a.switchPoiClassArray=function(b){try{var d=a.osmdocCat.features.slice(0),f=a.osmdocCat.features.indexOf(b);0>f?d.push(b):d.splice(f,1);return filterAndSort(d)}catch(g){return[]}};
a.poiClassTranslatedTitle=function(b){return b.title_by_lang&&b.title_by_lang[a.lng]?b.title_by_lang[a.lng]:b.translated_title[0]};a.$on("$locationChangeSuccess",function(){var d=a.activeFeatureID,f=k.getParameters();a.lng!=f.lang&&(h.lang=f.lang,k.reload());a.activeFeatureID=f.id;a.explain=f.explain;a.content=f.details?"details":"map";"details"==a.content?(ANALYTICS_CODE&&p.trackPage("/#!/"+a.lng+"/id/"+a.activeFeatureID+"/details"),l.showDetails(a,a.activeFeatureID),d&&l.closePopup(a,d)):(a.activeFeatureID?
(ANALYTICS_CODE&&p.trackPage("/#!/"+a.lng+"/id/"+a.activeFeatureID),l.showPopup(a,a.activeFeatureID)):void 0!==d&&d!=a.activeFeatureID&&l.closePopup(a,d),k.getParameters().map&&(d=k.getParameters().map,b.broadcastAction||b.setView(d[1],d[2],d[0])));f.strict&&(a.strictSearch=!0);f.q&&null==a.searchForm.q&&a.searchForm.q!=f.q&&(a.searchForm.q=f.q,a.$broadcast("Search",f.q));v()});a.$on("Search",function(){k.update("q",a.searchForm.q)});a.$on("SelectFeature",function(){k.update("q",a.searchForm.q)});
a.$on("HierarchyLoaded",v);a.$on("PopupClose",function(b,d){"map"==a.content&&k.update("id",null)});a.$on("PopupOpen",function(b,d,f){k.update({id:d,map:null});f&&l.loadPTRoutes(a,d,f)});a.$on("MapViewChanged",function(){k.update("map",b.getStateArray())});m=function(){a.osmdocCat&&(f.organizeCathegories(),0<a.osmdocCat.features.length?k.update("pt",a.osmdocCat.features.join()):k.update("pt",null),0<a.osmdocCat.groups.length?k.update("pg",a.osmdocCat.groups.join()):k.update("pg",null),b.filterMarkersByTypes(a,
f.expandCathegories(a)),f.updateSelections(a))};a.$on("CloseSearchResults",function(){a.searchForm.q="";a.searchResultsPage=null;a.srPages=null;b.filterMarkersByTypes(a,f.expandCathegories(a));f.updateSelections(a)});a.$on("SelectCathegoryTreeNode",m);a.$on("UnselectCathegoryTreeNode",m);a.formatObjectType=function(b){if(b){if(b.poi_class){var f=a.translateTypeNames(b);if(0<f.length)return f.join(", ")}if(b.weight_base_type)return d.tr(a,"weight_base_type."+b.weight_base_type)}return null};a.translateTypeNames=
function(b){var f=[];if(b&&b.poi_class)for(var d in b.poi_class){var g=b.poi_class[d];a.name2FClass&&a.name2FClass[g]&&(g=a.name2FClass[g].translated_title,g.toUpperCase()!==(b.name||"").toUpperCase()&&f.push(g))}return f};a.nameContainsType=function(b){if(b){var f=a.translateTypeNames(b);b=(b.name||"").toLowerCase();for(var d in f)if(0<=b.indexOf(f[d].toLowerCase()))return!0}return!1};a.tagValueHTML=function(b){return tagValueHTML(b,a,d)};a.buildingType=function(b){return d.tr(a,"details.adr.building")};
a.mergeIntoPath=function(a,b){return"/#!"+k.mergeIntoPath(a,b)};a.searchKeyDown=function(b){38==b.keyCode?(b.stopPropagation(),b.preventDefault(),a.$broadcast("SearchKeyUp")):40==b.keyCode&&a.$broadcast("SearchKeyDown")};a.$watch("searchForm.q",function(b,f){""!=f&&""==b&&a.$broadcast("CleanSearchInput")});a.$on("CleanSearchInput",function(){k.update("q",null)});a.navigate=function(a,b){k.update(a,b)};a.formatSearchResultTitle=function(b){if(!b)return"";if("adrpnt"==b.type)return d.tr(a,"map.js.search.title.adrpnt");
if(b.name||b.poi_class){var f=a.formatObjectType(b),g=b.name||f;b.name&&f&&(g+=" ("+f+")");return g}return""};a.formatSearchResultAddress=function(b){if(!b)return"";b=getAddress(b,a.translation?a.translation["addr.order"]:"hn-street-city");return void 0==b?"":b[0]};a.getAddress=function(b){return getAddress(b,a.translation?a.translation["addr.order"]:"hn-street-city")};a.selectRow=function(b){a.$broadcast("SelectFeature",b)};a.$on("SelectFeature",function(){a.searchForm.showSlider=!1});a.searchInputEnter=
function(){a.suggestedFeature?a.suggestedFeature.feature_id?a.$broadcast("SelectFeature",a.suggestedFeature):a.selectPoiType(a.suggestedFeature.name):a.$broadcast("Search",a.searchForm.q)};a.removeSelected=function(b,d){f.removeSelection(a,{name:b},d)};a.moveToBrowserGeoLocation=function(a){b.setView(a.lat,a.lon,14);b.saveStateToCookie()};a.getPTRoutes=function(b){return l.getPTRoutes(b)}}]);
function initLang(e){return e.lang?e.lang:"en-US"===(window.navigator.language||window.navigator.userLanguage)?"en":"ru"}disqus_shortname="osmme";var router=angular.module("meRouter",[]);
router.factory("routeService",["$location",function(e){function a(){this.parameters=[];this.byName={}}a.prototype.parameter=function(a,d,b,g){d={name:a,type:"parameter",escape:g||!0,slashes:d||0,skipSave:b||!1};this.byName[a]||(this.parameters.push(d),this.byName[a]=d)};a.prototype.anonymous=function(a,d,b,g){d={name:a,type:"anonymous",escape:g||!0,skipSave:b||!1};this.byName[a]||(this.parameters.push(d),this.byName[a]=d)};a.prototype.flag=function(a,d){var b={name:a,type:"flag",skipSave:d||!1};this.byName[a]||
(this.parameters.push(b),this.byName[a]=b)};a.prototype.template=function(){var a="/";angular.forEach(this.parameters,function(d){"anonymous"==d.type&&(a+=":"+d.name+"/");"flag"==d.type&&(a+="?"+d.name+"/");if("parameter"==d.type&&(a+=d.name+"/:"+d.name+"/",d.slashes))for(var b=0;b<d.slashes-1;b++)a+=":"+d.name+"/"});return a};a.prototype.getParameters=function(){var a=[];angular.forEach(e.path().split("/"),function(b){b&&a.push(b)});for(var d=0,b={},g=0;g<a.length;g++)for(var f=d;f<this.parameters.length;f++){var l=
this.parameters[f],t=a[g];if("anonymous"==l.type){b[l.name]=t;d++;break}else if("flag"==l.type&&l.name==t){b[l.name]=!0;d++;break}else if("parameter"==l.type&&l.name==t){if(l.slashes)for(f=g+1;f<Math.min(a.length,g+1+l.slashes);f++)b[l.name]||(b[l.name]=[]),b[l.name].push(a[f]);else b[l.name]=a[g+1];g+=l.slashes||1;d++;break}d++}return b};a.prototype.createPath=function(a){for(var d="/",b=0;b<this.parameters.length;b++){var g=this.parameters[b];"anonymous"==g.type&&a[g.name]&&(d+=a[g.name]+"/");"flag"==
g.type&&a[g.name]&&(d+=g.name+"/");if("parameter"==g.type&&a[g.name])if(d+=g.name+"/",g.slashes)for(var f=0;f<g.slashes;f++)d+=a[g.name][f]+"/";else d+=a[g.name]+"/"}return d};a.prototype.update=function(a,d,b){var g={};void 0===d&&void 0===b?g=a:g[a]=d;d=angular.extend(this.getParameters(),g);d=this.createPath(d);d=e.path(d);this.byName[a]&&this.byName[a].skipSave&&!b&&d.replace();return d};a.prototype.mergeIntoPath=function(a,d){var b={};void 0===d?b=a:b[a]=d;b=angular.extend(this.getParameters(),
b);return this.createPath(b)};a.prototype.reload=function(){window.location.reload()};return new a}]);var MapModule=angular.module("meMap",["ngCookies","meI18n"]);
(function(e,a){function h(a,b){var g=Math.pow(10,b);return Math.round(a*g)/g}a.factory("mapService",["i18nService","$rootScope","$cookies","$compile","$http",function(a,b,g,f,l){var e=L.Control.extend({container:null,options:{position:"topleft"},setScope:function(a){this.scope=a;return this},setContainer:function(a){var b=L.DomUtil.create("div","search-control");L.DomEvent.disableClickPropagation(b);L.DomEvent.addListener(b,"mousewheel",function(a){var b=document.getElementById("r-scroll-pane");b&&
(b.scrollTop-=20*L.DomEvent.getWheelDelta(a));L.DomEvent.stopPropagation(a)});b.innerHTML=a;this.container=b},onAdd:function(a){return this.container}}),m={id2Feature:{},id2Marker:{},ready:!1,createMap:function(k,p,h,r){p=p||g.lat||DEFAULT_LAT;if(90<p||-90>p)p=DEFAULT_LAT;h=h||g.lon||DEFAULT_LON;if(180<h||-180>h)h=DEFAULT_LON;r=r||g.z||DEFAULT_ZOOM;0>=r&&(r=DEFAULT_ZOOM);this.map=L.map("map",{zoomControl:!1}).setView([p,h],r);p=a.tr(k,"map.js.copy.data")+' &copy; <a href="http://osm.org">'+a.tr(k,
"map.js.copy.contributors")+"</a>, "+a.tr(k,"map.js.copy.rendering")+' <a href="http://giscience.uni-hd.de/" target="_blank">University of Heidelberg</a>';k.mobile&&(p='<a href="http://osm.org">OpenStreetMap</a>,  <a href="http://giscience.uni-hd.de/" target="_blank">University of Heidelberg</a>');p=L.tileLayer(MAPSURFER_TILES,{attribution:p,maxZoom:18}).addTo(this.map);h=a.tr(k,"map.js.copy.contributors")+'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a>';r=L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",
{attribution:h});h={};h[a.tr(k,"map.js.layer.relief")]=L.tileLayer("http://openmapsurfer.uni-hd.de/tiles/asterh/x={x}&y={y}&z={z}",{maxZoom:18});h[a.tr(k,"map.js.layer.contours")]=L.tileLayer("http://openmapsurfer.uni-hd.de/tiles/asterc/x={x}&y={y}&z={z}",{maxZoom:18});p={Mapnik:r,MapSurfer:p};k.mobile||(this.layersControl=L.control.layers(p,h),this.layersControl.addTo(this.map));var n=this.map;this.map.on("viewreset",function(){window.setTimeout(function(){m.saveStateToCookie.apply(m,[]);m.broadcastAction=
!0;k.$broadcast("MapViewChanged",n.getCenter(),n.getZoom());b.$$phase||b.$apply();m.broadcastAction=!1},10)});this.map.on("moveend",function(){window.setTimeout(function(){m.saveStateToCookie.apply(m,[]);m.broadcastAction=!0;k.$broadcast("MapViewChanged",n.getCenter(),n.getZoom());b.$$phase||b.$apply();m.broadcastAction=!1},10)});this.map.on("popupopen",function(a){var d=n.project(a.popup._latlng);d.y-=a.popup._container.clientHeight/2;n.panTo(n.unproject(d),{animate:!1});d=a.popup._source?a.popup._source.feature_id:
a.popup.feature_id;f(a.popup._contentNode)(k);k.$broadcast("PopupOpen",d,m.id2Feature[d].poi_class);b.$$phase||b.$apply()});this.map.on("popupclose",function(a){k.$broadcast("PopupClose",a.popup._source?a.popup._source.feature_id:a.popup.feature_id);b.$$phase||b.$apply()});this.ready=!0;if(!k.mobile){var q=this.searchControl=(new e).setScope(k);l.get(HTML_ROOT+"/templates/search_control.html").success(function(a){q.setContainer(a);q.addTo(n);f(q.container)(k)})}return this.map},createPopUP:function(a,
b){if(!this.id2Feature[b.feature_id]){this.id2Feature[b.feature_id]=b;var f=b.poi_class?a.name2FClass[b.poi_class[0]]:null,d=this;this.loadIcon(f,function(){var g=L.marker([b.center_point.lat,b.center_point.lon]);f&&f.ll_icon&&(g=L.marker([b.center_point.lat,b.center_point.lon],{icon:f.ll_icon}));d.id2Marker[b.feature_id]=g;var l=d.getPopUPHtml(b,b.feature_id,a,f);g.addTo(d.map).bindPopup(l);g.feature_id=b.feature_id})}},openPopUP:function(a,b,f){if(b&&this.id2Marker[b])if(angular.element(this.map.getContainer()).hasClass("ng-hide")){var d=
this,g=f||5;0<g&&window.setTimeout(function(){d.openPopUP.apply(d,[a,b,g])},100)}else this.id2Marker[b]._popup._isOpen||(this.map.invalidateSize(!1),this.id2Marker[b].openPopup())},closePopUP:function(a,b){b&&this.id2Marker[b]&&this.id2Marker[b].closePopup()},isPopUPExists:function(a,b){return b&&!!this.id2Marker[b]},getPopUPHtml:function(b,f,g,l){var e=g.formatSearchResultTitle(b);b=getAddress(b,g.translation?g.translation["addr.order"]:"hn-street-city")[0];g='<a class="more-link" href="'+g.mergeIntoPath({details:!0,
id:f})+'">'+a.tr(g,"map.js.popup.more")+"</a>";var h="";!l||"tram_stop"!=l.name&&"bus_stop"!=l.name||(h="<h5 ng-bind=\"translation['pt.routes']\"></h5><div ng-hide=\"getPTRoutes('"+f+'\') != null"><img ng-src="{{HTML_ROOT}}/img/loading.gif"/></div><div ng-show="getPTRoutes(\''+f+'\')" class="routes-list" ng-repeat="(type, refs) in getPTRoutes(\''+f+'\').routes"><span ng-bind="translation[\'pt.route.type.\' + type]"></span>&nbsp;<span class="route-ref" ng-repeat="ref in refs" ng-bind="ref"></span></div>');
return e?'<div class="fpopup"><h2>'+e+"</h2>"+h+"<div>"+b+"</div><div>"+g+"</div>":"<div>"+b+"</div>"+g},remove:function(a,b){void 0!==this.id2Feature[b]&&(this.id2Marker[b]&&(this.map.removeLayer(this.id2Marker[b]),delete this.id2Marker[b]),delete this.id2Feature[b],a.activeFeatureID=null)},clearAllMarkers:function(a){this.filterMarkersByTypes(a,[])},filterMarkersByTypes:function(a,b){var f=[];angular.forEach(this.id2Feature,function(a,d){0>b.indexOf(a.class_name)&&f.push(d)});angular.forEach(f,
function(b){m.remove.apply(m,[a,b])})},getStateString:function(){var a=this.map.getCenter(),b=this.map.getZoom();return 0<b&&90>a.lat&&-90<a.lat&&-180<a.lng&&180>a.lng?b+"/"+h(a.lat,5)+"/"+h(a.lng,5):null},getStateArray:function(){var a=this.map.getCenter(),b=this.map.getZoom();return 0<b&&90>a.lat&&-90<a.lat&&-180<a.lng&&180>a.lng?[b,h(a.lat,5),h(a.lng,5)]:null},saveStateToCookie:function(){var a=this.map.getCenter(),b=this.map.getZoom();0<b&&90>a.lat&&-90<a.lat&&-180<a.lng&&180>a.lng&&(g.lat=a.lat,
g.lon=a.lng,g.z=b)},setView:function(a,b,f){0<f&&90>a&&-90<a&&-180<b&&180>b&&this.map&&this.map.setView([a,b],f)},enquirePosition:function(a){"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(a)},imgWaiters:{},loadIcon:function(a,b){if(a)if(void 0===a.ll_icon){var f=TYPE_ICONS_ROOT+"/"+a.icon;if(void 0===this.imgWaiters[f]){thisClosure=this;this.imgWaiters[f]=[];this.imgWaiters[f].push(b);var d=new Image;d.onload=function(){a.ll_icon=L.icon({iconUrl:f,iconSize:[32,37],iconAnchor:[16,
37],popupAnchor:[0,-38]});for(var b=0;b<thisClosure.imgWaiters[f].length;b++)thisClosure.imgWaiters[f][b]();thisClosure.imgWaiters[f]=null};d.onerror=function(){a.ll_icon=null;for(var b=0;b<thisClosure.imgWaiters[f].length;b++)thisClosure.imgWaiters[f][b]();thisClosure.imgWaiters[f]=null};d.src=f}else null===this.imgWaiters[f]?b():this.imgWaiters[f].push(b)}else b();else b()}};return m}])})(angular,MapModule);var meI18n=angular.module("meI18n",["ngResource"]);
meI18n.factory("i18nService",["$resource",function(e){return{getTranslation:function(a,h,d,b){var g=HTML_ROOT+"/i18n/map_"+h+".json",f="map.js_"+h;sessionStorage&&!d?sessionStorage.getItem(f)?(a.translation=JSON.parse(sessionStorage.getItem(f)),b&&b()):e(g).get(function(d){a.translation=d;sessionStorage.setItem(f,JSON.stringify(a.translation));b()}):e(g).get(function(f){a.translation=f;b()})},tr:function(a,e){return void 0!==a.translation&&void 0!==a.translation[e]?a.translation[e]:e}}}]);var meIGeocoder=angular.module("meIGeocoder",["ngResource","meMap","meDetails"]);
(function(e,a){a.factory("iGeocoder",["$http","mapService","details",function(a,d,b){return{create:function(a,b){var e=this;b.on("click",function(a){14<b.getZoom()&&e.sendRequest(a.latlng.lng,a.latlng.lat)});this.scope=a;a.closeIGeocodeResults=function(){a.$broadcast("CloseInverseGeocodeResults")};a.$on("CloseInverseGeocodeResults",function(){a.inverseGeocodeResults=null;d.filterMarkersByTypes(a,[])})},sendRequest:function(b,f,d,e){var m=this;b=API_ROOT+"/location/latlon/"+f+"/"+b;if(void 0==d||d)b+=
"/_related";void 0==e?(b+="?&max_neighbours="+(("undefined"!==typeof IGEOCODE_NEIGHBOURS?IGEOCODE_NEIGHBOURS:8)||8),a.get(b).success(function(a){m.showAnswer.apply(m,[a])})):a.get(b+"?largest_level=all&max_neighbours=0&full_geometry=false").success(e)},showAnswer:function(a){if(a){this.scope.inverseGeocodeResults=a;var b=this.scope;a.feature_id&&(this.scope.$broadcast("CloseSearchResults",a.feature_id),d.createPopUP(b,a),d.openPopUP(b,a.feature_id));a._related&&a._related._same_building&&angular.forEach(a._related._same_building,
function(a){d.createPopUP(b,a)});a._eclosed&&angular.forEach(a._eclosed,function(a){d.createPopUP(b,a)});a._neighbours&&angular.forEach(a._neighbours,function(a){d.createPopUP(b,a)})}}}}])})(angular,meIGeocoder);var meSearch=angular.module("meSearch",["meMap","meOSMDoc"]);
meSearch.factory("search",["$http","mapService","docTree",function(e,a,h){var d={resetMap:!1,selectedSuggestion:-1,queryHead:null,userSearchInput:"",restrictWithBBOX:!1,suggestTimer:null,attach:function(b){b.$on("MapViewChanged",function(a){d.pagesMode||d.listPOI.apply(d,[b,1])});b.$on("SelectCathegoryTreeNode",function(){b.searchForm.q="";delete b.searchResultsPage.features;d.pagesMode=!1;d.listPOI.apply(d,[b,1])});b.$on("UnselectCathegoryTreeNode",function(){d.pagesMode=!1;d.listPOI.apply(d,[b,
1])});b.$on("Search",function(){d.pagesCenter=a.map.getCenter();d.search.apply(d,[b,1])});b.$on("SearchKeyUp",function(){d.moveUp.apply(d,[b])});b.$on("SearchKeyDown",function(){d.moveDown.apply(d,[b])});b.$on("SelectFeature",function(d,f){a.openPopUP(b,f.feature_id)});b.$watch("searchForm.q",function(a,f){d.suppressOnSearchQuerry?d.suppressOnSearchQuerry=!1:(d.suggestTimer&&window.clearTimeout(d.suggestTimer),d.suggestTimer=window.setTimeout(function(){d.suggest(b)},300))});b.$watch("activePoiFilters",
function(g,f){f&&g&&(d.pagesMode=!1,a.clearAllMarkers(b),d.listPOI.apply(d,[b,1]))},!0);b.searchResultsPage={};b.getSRPages=function(){d.listPages(b)};b.goPage=function(a){d.search(b,a.p)}},search:function(a,g){d.restrictWithBBOX=!1;d.userSearchInput="";if(a.searchForm.q){var f={q:a.searchForm.q,mark:d.getHash(a),page:g,hierarchy:a.hierarchyCode,explain:a.explain};a.osmdocCat&&(a.osmdocCat.features||a.osmdocCat.groups)&&(f.poiclass=a.osmdocCat.features,f.poigroup=a.osmdocCat.groups);a.strictSearch&&
(f.strict=!0);a.searchAddressesOnly&&(f.only_address=!0);d.pagesCenter&&(f.lat=d.pagesCenter.lat,f.lon=d.pagesCenter.lng);e.get(API_ROOT+"/location/_search",{params:f}).success(function(f){d.searchSuccess.apply(d,[a,f])})}},searchSuccess:function(b,g){if("success"==g.result){var f=this.getHash(b);if(g.mark==f){a.closePopUP(b,b.activeFeatureID);b.searchResultsPage&&b.searchResultsPage.features&&angular.forEach(b.searchResultsPage.features,function(f){a.remove(b,f.feature_id)});b.searchResultsPage=
g;b.getSRPages();var e=[];angular.forEach(g.features,function(f,d){a.createPopUP(b,f,f.feature_id);e.push(f.center_point)});d.resetMap&&e&&0<e.length&&a.map.fitBounds(L.latLngBounds(e))}}},suggest:function(a){if(a.searchForm.q&&!(3>a.searchForm.q.length)&&(d.selectedSuggestion=-1,a.selectedSuggestion=-1,!d.waitForAnswer)){d.waitForAnswer=!0;var g={q:a.searchForm.q,size:10,mark:this.getHash(a),hierarchy:a.hierarchyCode};a.strictSearch&&(g.strict=!0);a.searchAddressesOnly&&(g.only_address=!0);e.get(API_ROOT+
"/location/_suggest",{params:g}).success(function(f){d.waitForAnswer=!1;d.searchSuccess.apply(d,[a,f])})}},listPOI:function(b,g){if(0!=h.cathegories.features.length||0!=h.cathegories.groups){d.restrictWithBBOX=!0;var f={q:b.searchForm.q,poiclass:h.cathegories.features,poigroup:h.cathegories.groups,bbox:a.map.getBounds().toBBoxString(),size:20,page:g,mark:d.getHash(b),hierarchy:b.hierarchyCode},l=d.notNullPoiFilters(b);l&&(f.tag_filters=l);e.get(API_ROOT+"/location/_search",{params:f}).success(function(a){"success"==
a.result&&d.listPOISuccess.apply(d,[a,b])})}},listPOISuccess:function(b,g){var f=d.getHash(g);b.mark==f&&(angular.forEach(b.features,function(b,f){a.createPopUP(g,b)}),b.page*b.size<b.hits&&10>b.page&&d.listPOI(g,b.page+1))},getHash:function(a){var d=this.notNullPoiFilters(a);return(""+{poiclass:a.osmdocCat.features,poigroup:a.osmdocCat.groups,query:a.searchForm.q,poifilters:d}).hashCode()},listPages:function(a){var d={};if(a.searchResultsPage){var f=a.searchResultsPage.hits,e=a.searchResultsPage.page,
h=a.searchResultsPage.size,m=parseInt(f/h);0==f%h&&(m+=1);for(f=1;f<=m&&8>=f;f++)d[f]={p:f,active:e==f};for(f=e-1;f<=e+1;f++)0<f&&f<=m&&(d[f]={p:f,active:e==f});for(f=m-2;f<=m;f++)0<f&&(d[f]={p:f,active:e==f})}var k=[];angular.forEach(d,function(a){k.push(a)});k.sort(function(a,b){return a.p-b.p});a.srPages=k},moveUp:function(a){d.selectedSuggestion--; -1>=d.selectedSuggestion&&(d.selectedSuggestion=-1);if(-1==d.selectedSuggestion)a.searchForm.q=d.userSearchInput,a.selectedSuggestion=null,a.suggestedFeature=
null;else{var e=a.searchResultsPage.matched_type.slice(0),e=e.concat(a.searchResultsPage.features);a.searchForm.q.split(/[\s,;.]+/);var e=e[d.selectedSuggestion],f=d.getToken(e),l=" "===d.queryHead.slice(-1)?"":" ",f=d.queryHead+l+f,f=" "===f.slice(-1)?f:f+" ";d.suppressOnSearchQuerry=!0;a.searchForm.q=f;a.selectedSuggestion=d.getId(e);a.suggestedFeature=e}},moveDown:function(a){var e=a.searchForm.q.split(/[\s,;.]+/);-1==d.selectedSuggestion&&(d.userSearchInput=a.searchForm.q,e.pop(),d.queryHead=
e.join(" "));e=a.searchResultsPage.matched_type.slice(0);e=e.concat(a.searchResultsPage.features);d.selectedSuggestion++;d.selectedSuggestion>=e.length&&(d.selectedSuggestion=e.length-1);var e=e[d.selectedSuggestion],f=d.getToken(e),l=" "===d.queryHead.slice(-1)?"":" ",f=d.queryHead+l+f,f=" "===f.slice(-1)?f:f+" ";d.suppressOnSearchQuerry=!0;a.searchForm.q=f;a.selectedSuggestion=d.getId(e);a.suggestedFeature=e},notNullPoiFilters:function(a){a=a.activePoiFilters;if(!a)return null;for(var d={},f=Object.keys(a),
e=0;e<f.length;e++){var h=f[e];if(angular.isObject(a[h])){for(var m=a[h],k=Object.keys(m),p=[],v=0;v<k.length;v++){var r=k[v];m[r]&&p.push(r)}p&&0<p.length&&(d[h]=p)}else a[h]&&(d[h]=!0)}return 0==Object.keys(d)?null:d},getToken:function(a){return a.type?a.name||a.housenumber:a.translated_title[0]},getId:function(a){return a.feature_id||a.name}};return d}]);var meOSMDoc=angular.module("meOSMDoc",["meMap"]);
(function(e,a){function h(a,b,e){a&&(angular.forEach(a.features,function(a){b.feature&&b.feature(a,e)}),angular.forEach(a.groups,function(a){e.push(a.name);b.group&&b.group(a);h(a,b,e);e.pop(a.name)}))}a.factory("docTree",["$http","mapService",function(a,b){var g={SUPPORTED_HIERARCHIES:["osm-ru"],cathegories:{features:[],groups:[]},attach:function(a){a.osmdocCat=g.cathegories;a.expand=function(a){a.expanded=!a.expanded};a.selectPoiType=function(b){g.selectPoiType.apply(g,[a,b])};a.selectCathegory=
function(d,e){d.selected?g.addSelection.apply(g,[a,d,e]):g.removeSelection.apply(g,[a,d,e]);var h=g.expandCathegories.apply(g,[a]);b.filterMarkersByTypes.apply(b,[a,h])};a.listMoreTags=function(b){if(!b||!a.name2FClass)return null;if(b.__translatedTags&&0<b.__translatedTags.length)return b.__translatedTags;var d=b.poi_class,e=[];angular.forEach(b.more_tags,function(b,g){if("description"!=g)for(var h in d){var l={},n=a.name2FClass[d[h]];n&&(n=n.more_tags[g])&&(l.name=n.name,l.type=n.valueType,l.key=
g,n.values[b]?(l.value=n.values[b].name,l.group=n.values[b].group):l.value=b,e.push(l))}});return b.__translatedTags=e}},selectPoiType:function(a,b){this.addSelection(a,a.name2FClass[b],"features")},loadTree:function(b,e,g){a.get(API_ROOT+"/osmdoc/hierarchy/"+e+"/"+g).success(function(a){b.hierarchy=a;h(b.hierarchy,{feature:function(a){b.name2FClass[a.name]=a},group:function(a){b.name2Group[a.name]=a}},[]);b.$broadcast("HierarchyLoaded")})},expandCathegories:function(a){if(!a.hierarchy)return[];var b=
{};e.forEach(this.cathegories.features,function(a){b[a]=1});var d=this;h(a.hierarchy,{feature:function(a,f){e.forEach(d.cathegories.groups,function(d){0<=f.indexOf(d)&&(b[a.name]=1)})}},[]);var g=[];e.forEach(b,function(a,b){g.push(b)});return g},addSelection:function(a,b,d){d=this.cathegories[d];b&&d&&d.push(b.name);a.$broadcast("SelectCathegoryTreeNode");this.loadTagValuesStatistic(a)},removeSelection:function(a,b,d){d=this.cathegories[d];if(b&&d)for(var e=0;e<d.length;e++)if(d[e]==b.name){d.splice(e,
1);break}a.$broadcast("UnselectCathegoryTreeNode");this.loadTagValuesStatistic(a)},updateSelections:function(a){h(a.hierarchy,{group:function(a){a.selected=0<=g.cathegories.groups.indexOf(a.name)},feature:function(a,b){a.selected=0<=g.cathegories.features.indexOf(a.name)}},[])},getHierarchyCode:function(a){a="osm-"+a;return 0>g.SUPPORTED_HIERARCHIES.indexOf(a)?g.SUPPORTED_HIERARCHIES[0]:a},organizeCathegories:function(){g.cathegories.groups=filterAndSort(g.cathegories.groups);g.cathegories.features=
filterAndSort(g.cathegories.features)},loadTagValuesStatistic:function(b){var e=this.cathegories.features,g=this.cathegories.groups;0<e.length||0<g.length?a.get(API_ROOT+"/osmdoc/statistic/tagvalues.json",{params:{poiclass:e,poigroup:g,hierarchy:b.hierarchyCode}}).success(function(a){var d={_ordered_keys:[]},e=a.common_tags;0<=e.indexOf("opening_hours")&&(d.opening_hours={key:"opening_hours",type:"WORKING_HOURS",title:b.translation["details.poi.tag.values.wh.24_7"]},d._ordered_keys.push("opening_hours"));
for(var g=b.name2FClass[a.poi_class[0]],h={opening_hours:{"24_7":!1}},l=0;l<e.length;l++){var q=e[l],t=[],u=Object.keys(a.tags[q])||[];if(u&&0<u.length){for(var w=0;w<u.length;w++){var x=u[w];if(g&&g.more_tags&&g.more_tags[q]){var y=g.more_tags[q].values;y&&y[x]&&t.push({valueKey:x,valueTitle:y[x].name})}}if(0<t.length)for(d[q]={key:q,type:g.more_tags[q].valueType,title:g.more_tags[q].name,options:t},d._ordered_keys.push(q),h[q]={},u=0;u<t.length;u++)h[q][t[u].valueKey]=!1;else g.more_tags[q]&&"BOOLEAN"==
g.more_tags[q].valueType&&(h[q]=!1,d[q]={key:q,type:g.more_tags[q].valueType,title:g.more_tags[q].name},d._ordered_keys.push(q))}}b.poi_subfilters=d;b.activePoiFilters=h}):b.poi_subfilters=null}};return g}])})(angular,meOSMDoc);var meDetails=angular.module("meDetails",["meMap","meI18n"]);
meDetails.factory("details",["$http","$timeout","$rootScope","mapService","i18nService",function(e,a,h,d,b){var g={cache:new FixedSizeFIFOCache,ptCache:new FixedSizeFIFOCache(200),showPopup:function(a,b){d.isPopUPExists(a,b)?d.openPopUP(a,b):b&&(this.cache.get(b)?(d.createPopUP(a,this.cache.get(b)),d.openPopUP(a,b)):this._load(a,b,!1,function(e){d.createPopUP(a,e);d.openPopUP(a,b)}))},closePopup:function(a,b){b&&d.isPopUPExists(a,b)&&d.closePopUP(a,b)},showDetails:function(a,d){d&&(a.moreLikeThis=
null,this.cache.get(d)&&this.cache.get(d)._related?(a.objectDetails=this.cache.get(d),a.content="details",a.moreLikeThisH4=b.tr(a,"details.poi.more").format((a.formatObjectType(a.objectDetails)||"").toLowerCase())):this._load(a,d,!0,function(d){a.objectDetails=d;a.content="details";a.moreLgetPTRoutesikeThisH4=b.tr(a,"details.poi.more").format((a.formatObjectType(a.objectDetails)||"").toLowerCase())}))},getPTRoutes:function(a){return g.ptCache.get(a)},loadPTRoutes:function(a,b,d){if(("tram_stop"==
d[0]||"bus_stop"==d[0])&&null==g.ptCache.get(b)&&(a=b.split("-")[2])){d="";if("n"==a.charAt(0))d+="node";else if("w"==a.charAt(0))d+="way";else if("r"==a.charAt(0))d+="rel";else return;d+="("+a.substring(1)+");";e.post("http://overpass-api.de/api/interpreter","data="+("[out:json];("+d+");<<; out tags qt;")).success(function(a){if(a.elements){for(var d={},e=0;e<a.elements.length;e++){var f=a.elements[e];if("relation"==f.type&&"route"==f.tags.type){var r=f.tags.route;!r||"bus"!=r&&"tram"!=r||(null==
d[r]&&(d[r]=[]),d[r].push(f.tags.ref))}}g.ptCache.put(b,{id:b,routes:d});h.$$phase||h.$apply()}})}},_load:function(a,b,h,m){var k=API_ROOT+"/location/"+b;h&&(k+="/_related");e.get(k).success(function(e){function h(a,b){d.ready?k(a,b):window.setTimeout(function(){h(a,b)},500)}function k(a,d){g.cache.put.apply(g.cache,[b,d]);m(d)}e&&e.feature_id&&h(a,e)})}};return g}]);FixedSizeFIFOCache=function(e){this.size=e||20;this.storage={};this.queue={};this.pointer=0};
FixedSizeFIFOCache.prototype.inc=function(){this.pointer+=1;this.pointer==this.size&&(this.pointer=0)};FixedSizeFIFOCache.prototype.put=function(e,a){this.storage[e]?this.storage[e]=a:(this.storage[e]=a,delete this.storage[this.queue[this.pointer]],this.inc())};FixedSizeFIFOCache.prototype.get=function(e){return this.storage[e]};
